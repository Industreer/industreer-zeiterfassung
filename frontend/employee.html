<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Zeiterfassung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      padding: 20px;
    }
    .box {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      max-width: 420px;
      margin: 40px auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { margin-top: 0; }
    label { display:block; margin-top:10px; font-weight:bold; }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      font-size: 16px;
    }
    button {
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .start { background:#2e7d32; color:#fff; }
    .break { background:#f9a825; color:#000; }
    .end { background:#c62828; color:#fff; }
    .pdf { background:#1565c0; color:#fff; }
    .msg {
      margin-top: 15px;
      font-size: 15px;
      min-height: 22px;
    }
    .ok { color: green; }
    .err { color: red; }
    .status {
      background:#eef;
      padding:10px;
      border-radius:6px;
      margin-top:15px;
      font-size:14px;
    }
  </style>
</head>
<body>

<div class="box">
  <h1>Zeiterfassung</h1>

  <!-- LOGIN -->
  <div id="loginBox">
    <label>Mitarbeiter-ID</label>
    <input id="employeeId" placeholder="ID eingeben">
    <button class="start" onclick="login()">Anmelden</button>
  </div>

  <!-- MAIN -->
  <div id="mainBox" style="display:none">
    <div class="status" id="liveStatus">Nicht eingestempelt</div>

    <button class="start" onclick="startWork()">ðŸŸ¢ Arbeitsbeginn</button>

    <label>Raucherpause (Minuten)</label>
    <input id="breakMinutes" type="number" min="1" max="120" value="10">
    <button class="break" onclick="addBreak()">ðŸš¬ Pause erfassen</button>

    <button class="end" onclick="endWork()">ðŸ”´ Arbeitsende</button>

    <hr>

    <button class="pdf" onclick="printLastWeek()">ðŸ“„ Stundenzettel letzte Woche</button>
    <button class="pdf" onclick="printChooseWeek()">ðŸ“„ Stundenzettel fÃ¼r KW wÃ¤hlen</button>

    <div class="msg" id="statusMsg"></div>
  </div>
</div>

<script>
let EMPLOYEE_ID = null;
let startTime = null;

function login() {
  const id = document.getElementById("employeeId").value.trim();
  if (!id) return;

  EMPLOYEE_ID = id;
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("mainBox").style.display = "block";
  setStatus("Angemeldet als " + id, true);
}

function setStatus(text, ok=true) {
  const el = document.getElementById("statusMsg");
  el.textContent = text;
  el.className = "msg " + (ok ? "ok" : "err");
}

function setLive(text) {
  document.getElementById("liveStatus").textContent = text;
}

async function startWork() {
  const r = await fetch("/api/time/start", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ employee_id: EMPLOYEE_ID })
  });
  const j = await r.json();
  if (j.ok) {
    startTime = new Date();
    setLive("ðŸ•’ Arbeitszeit lÃ¤uft seit " + startTime.toLocaleTimeString("de-DE"));
    setStatus(j.message, true);
  } else {
    setStatus("Fehler beim Arbeitsbeginn", false);
  }
}

async function addBreak() {
  const minutes = Number(document.getElementById("breakMinutes").value || 0);
  if (minutes <= 0) return;

  const r = await fetch("/api/time/break", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ employee_id: EMPLOYEE_ID, minutes })
  });
  const j = await r.json();
  if (j.ok) {
    setLive("ðŸš¬ Pause erfasst (" + minutes + " Min)");
    setStatus(j.message, true);
  } else {
    setStatus("Fehler bei Pause", false);
  }
}

async function endWork() {
  const r = await fetch("/api/time/end", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ employee_id: EMPLOYEE_ID })
  });
  const j = await r.json();
  if (j.ok) {
    setLive("ðŸ”´ Arbeitsende â€“ Heute: " + j.totalHours.toFixed(2) + " Std");
    setStatus("Arbeitszeit abgeschlossen", true);
  } else {
    setStatus(j.error || "Fehler beim Arbeitsende", false);
  }
}

function printLastWeek() {
  const kw = prompt("Kalenderwoche (z. B. CW49):");
  if (!kw) return;
  window.open(`/api/pdf/timesheet/${EMPLOYEE_ID}/${kw}/PO123`, "_blank");
}

function printChooseWeek() {
  const kw = prompt("Kalenderwoche eingeben (z. B. CW49):");
  if (!kw) return;
  window.open(`/api/pdf/timesheet/${EMPLOYEE_ID}/${kw}/PO123`, "_blank");
}
</script>

</body>
</html>
