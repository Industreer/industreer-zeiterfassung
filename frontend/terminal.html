<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Zeiterfassung – Terminal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { background:#111; color:#fff; font-family:Arial; text-align:center; padding:22px; }
  .card { background:#222; padding:18px; border-radius:10px; max-width:360px; margin:0 auto 14px; }
  input, select, button { width:100%; padding:12px; margin:8px 0; font-size:1.05em; }
  button { cursor:pointer; }
  .ok { color:#0f0; font-size:1.15em; white-space:pre-line; }
  .err { color:#f66; white-space:pre-line; }
</style>
</head>
<body>

<div class="card" id="loginCard">
  <h2>Mitarbeiter Anmeldung</h2>
  <input id="empId" placeholder="Mitarbeiter-ID">
<input id="loginDate" type="date">
  <button onclick="login()">Anmelden</button>
  <div class="err" id="loginErr"></div>
</div>

<div class="card" id="projectCard" style="display:none">
  <h2 id="welcome"></h2>
  <select id="projectSelect"></select>
  <input id="workDate" type="date">
  <input id="manualProject" placeholder="Ausnahme Projekt-ID">
  <button onclick="useManual()">Ausnahme verwenden</button>
  <button onclick="confirmProject()">Weiter</button>
  <div class="err" id="projErr"></div>
</div>

<div class="card" id="actionCard" style="display:none">
  <div class="ok" id="headerText"></div>
<button onclick="sendEvent('clock_in')">Arbeitsbeginn</button>
<button onclick="sendEvent('break_start')">Pause Start</button>
<button onclick="sendEvent('break_end')">Pause Ende</button>
<button onclick="sendEvent('clock_out')">Arbeitsende</button>
  <div class="err" id="eventErr"></div>
</div>
<script>
  var employee = null;
  var projectId = null;

  function chosenDate() {
    var el = document.getElementById("workDate");
    return (el && el.value) ? el.value : new Date().toISOString().slice(0, 10);
  }

  window.login = async function () {
    var loginErrEl = document.getElementById("loginErr");
    var empEl = document.getElementById("empId");
    loginErrEl.innerText = "";

    var id = (empEl.value || "").trim();
    if (!id) {
      loginErrEl.innerText = "Bitte Mitarbeiter-ID oder Namen eingeben";
      return;
    }

    try {
var dateEl = document.getElementById("loginDate");
var date = (dateEl && dateEl.value) ? dateEl.value : "";
if (!date) { loginErrEl.innerText = "Bitte Datum auswählen"; return; }

var r = await fetch(
  "/api/terminal/login?employee_id=" + encodeURIComponent(id) +
  "&date=" + encodeURIComponent(date)
);

      var t = await r.text();
      var d;
      try { d = JSON.parse(t); } catch (e) { d = { ok: false, error: t }; }

      if (!r.ok || d.ok === false) {
        loginErrEl.innerText = d.error || "Mitarbeiter nicht gefunden";
        return;
      }

      employee = d.employee;
      await loadProjects();
    } catch (e) {
      loginErrEl.innerText = "❌ " + (e && e.message ? e.message : String(e));
    }
  };

  async function loadProjects() {
    var projErrEl = document.getElementById("projErr");
    projErrEl.innerText = "";

    // set default date when opening project card
    var wd = document.getElementById("workDate");
    if (wd && !wd.value) {
      wd.value = new Date().toISOString().slice(0, 10);
    }

    var r = await fetch(
      "/api/allowed-projects?employee_id=" +
        encodeURIComponent(employee.employee_id) +
        "&date=" + encodeURIComponent(document.getElementById("loginDate").value)
    );
    var d = await r.json();

    var projectSelect = document.getElementById("projectSelect");
    projectSelect.innerHTML = "";

    if (d.projects && d.projects.length) {
      d.projects.forEach(function (p) {
        var o = document.createElement("option");
        o.value = p.project_id;
        o.textContent = p.project_id + " – " + p.name;
        projectSelect.appendChild(o);
      });
    } else {
      var o2 = document.createElement("option");
      o2.value = "";
      o2.textContent = "Kein Projekt zugewiesen";
      projectSelect.appendChild(o2);
    }

    document.getElementById("welcome").innerText = "Hallo " + (employee.name || employee.employee_id);
    document.getElementById("loginCard").style.display = "none";
    document.getElementById("projectCard").style.display = "block";
  }

  window.useManual = function () {
    var v = (document.getElementById("manualProject").value || "").trim();
    var projErrEl = document.getElementById("projErr");
    projErrEl.innerText = "";

    if (!v) {
      projErrEl.innerText = "Projekt-ID fehlt";
      return;
    }
    projectId = v;
    showActions("(Ausnahme)");
  };

  window.confirmProject = function () {
    var projErrEl = document.getElementById("projErr");
    projErrEl.innerText = "";

    var v = document.getElementById("projectSelect").value;

    if (!v) {
      projectId = null;
      showActions("(kein Projekt)");
      return;
    }

    projectId = v;
    showActions("");
  };

  function showActions(extra) {
    document.getElementById("projectCard").style.display = "none";
    document.getElementById("actionCard").style.display = "block";
    document.getElementById("headerText").innerText =
      (employee && (employee.name || employee.employee_id) ? (employee.name || employee.employee_id) : "") +
      "\nProjekt: " + (projectId ? projectId : "-") + " " + (extra || "");
  }

  window.sendEvent = async function (type) {
    var eventErrEl = document.getElementById("eventErr");
    eventErrEl.innerText = "";

    if (!employee || !employee.employee_id) {
      eventErrEl.innerText = "Kein Mitarbeiter";
      return;
    }

    var url = null;
    var body = null;

    if (type === "clock_in") {
      url = "/api/clock/in";
      body = { employee_id: employee.employee_id, project_id: projectId || null };
    } else if (type === "clock_out") {
      url = "/api/clock/out";
      body = { employee_id: employee.employee_id };
    } else if (type === "break_start") {
      url = "/api/break/start";
      body = { employee_id: employee.employee_id };
    } else if (type === "break_end") {
      url = "/api/break/end";
      body = { employee_id: employee.employee_id };
    } else {
      eventErrEl.innerText = "Unbekannter Event-Typ";
      return;
    }

    try {
      var rr = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      var tt = await rr.text();
      var dd;
      try { dd = JSON.parse(tt); } catch (e) { dd = { ok: false, error: tt }; }

      if (!rr.ok || dd.ok === false) throw new Error(dd.error || "Zeitbuchung fehlgeschlagen");

      var actionCard = document.getElementById("actionCard");
      actionCard.innerHTML = '<div class="ok">✅ Gespeichert (' + type + ')</div>';
      setTimeout(function () { location.reload(); }, 2500);
    } catch (e) {
      eventErrEl.innerText = "❌ " + (e && e.message ? e.message : String(e));
    }
  };
</script>

</body>
</html>
