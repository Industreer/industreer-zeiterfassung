<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin – Mitarbeiter IDs</title>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:1200px}
    h1{margin:0 0 10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:10px 12px;font-size:14px}
    input[type="text"]{min-width:260px}
    button{cursor:pointer}
    .card{border:1px solid #ddd;border-radius:10px;padding:16px;margin:14px 0}
    .muted{color:#666}
    .ok{color:#0a7b2e}
    .bad{color:#b10000}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .small{font-size:12px}
    img.logo-preview{max-height:80px;border:1px solid #ddd;padding:6px;border-radius:6px;background:#fff}

    table{border-collapse:collapse;width:100%;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;vertical-align:top}
    th{background:#fafafa}
    .tag{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid #ddd}
    .tag.auto{border-color:#f0b4b4;background:#fff5f5}
    .tag.manual{border-color:#b4d6f0;background:#f5fbff}
  </style>
</head>

<body>

<h1>Admin – Mitarbeiter IDs (Hybrid)</h1>
<div class="muted">
  Ziel: AUTO_* IDs auf echte Mitarbeiter-IDs umhängen (inkl. Staffplan/Zeiten/Pausen).
</div>

<!-- ====================================================== -->
<!-- LOGO UPLOAD -->
<!-- ====================================================== -->
<div class="card">
  <h3 style="margin:0 0 8px">Firmenlogo</h3>

  <div class="muted small" style="margin-bottom:10px">
    Das Logo wird z.B. für PDFs / Reports verwendet.
    Empfohlen: <b>PNG mit transparentem Hintergrund</b>.
  </div>

  <div class="row">
    <input id="logoFile" type="file" accept="image/png"/>
    <button id="btnUploadLogo">Logo hochladen</button>
    <span id="logoOut" class="small muted"></span>
  </div>

  <div style="margin-top:12px">
    <div class="muted small">Aktuelles Logo:</div>
    <img id="logoPreview" class="logo-preview" src="/api/logo" alt="Kein Logo vorhanden"
         onerror="this.style.display='none'">
  </div>
</div>

<!-- ====================================================== -->
<!-- CONTROLS -->
<!-- ====================================================== -->
<div class="card">
  <div class="row">
    <button id="btnReload">Neu laden</button>
    <label class="muted">Suche:</label>
    <input id="q" type="text" placeholder="Name oder ID (z.B. Damir, AUTO_, 0815)"/>
    <label class="muted">Filter:</label>
    <select id="filter">
      <option value="all">Alle</option>
      <option value="auto">Nur AUTO_* (id_source=auto)</option>
      <option value="manual">Nur manuell</option>
      <option value="used">Mit Daten (staffplan/time/breaks > 0)</option>
    </select>
    <span id="status" class="muted"></span>
  </div>
</div>

<!-- ====================================================== -->
<!-- AUTO_* UMHÄNGEN -->
<!-- ====================================================== -->
<div class="card">
  <h3 style="margin:0 0 8px">AUTO_* umhängen</h3>
  <div class="muted small" style="margin-bottom:10px">
    Vorgehen: <b>alte AUTO_…</b> auswählen → <b>neue echte ID</b> eingeben → „Umhängen“.
  </div>

  <div class="row">
    <label>Alte ID (AUTO_*):</label>
    <select id="oldId"></select>

    <label>Neue ID:</label>
    <input id="newId" type="text" placeholder="z.B. 0815"/>

    <label class="muted">Merge-Modus:</label>
    <select id="merge">
      <option value="keep_new">keep_new (bestehende neue Daten behalten)</option>
      <option value="keep_old">keep_old (Name/Email/Sprache von alt übernehmen)</option>
    </select>

    <button id="btnMove">Umhängen</button>
  </div>

  <div id="moveResult" class="small" style="margin-top:10px"></div>
</div>

<!-- ====================================================== -->
<!-- RESET (optional, damit JS nicht crasht, falls du es nutzt) -->
<!-- ====================================================== -->
<div class="card">
  <h3 style="margin:0 0 8px">Tools: Import-Daten zurücksetzen</h3>
  <div class="muted small" style="margin-bottom:10px">
    Vorsicht: löscht serverseitig Importdaten (nur nutzen, wenn du es wirklich willst).
  </div>
  <div class="row">
    <label class="muted">Bestätigung:</label>
    <input id="resetConfirm" type="text" placeholder='RESET-ALL-IMPORT-DATA'/>
    <button id="btnResetImport">Reset ausführen</button>
    <span id="resetOut" class="small muted"></span>
  </div>
</div>

<!-- ====================================================== -->
<!-- MITARBEITERÜBERSICHT + EDIT (1:1 TAUSCH – FERTIG) -->
<!-- ====================================================== -->
<div class="card">
  <h3 style="margin:0 0 8px">Mitarbeiterübersicht</h3>
  <div class="muted small">
    Email & Sprache sind hier editierbar. Email: direkt editieren → „Speichern“ je Zeile. Sprache: Auto-Save (sofort).
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Email</th>
        <th>Sprache</th>
        <th>Quelle</th>
        <th>Staffplan</th>
        <th>Zeiten</th>
        <th>Pausen</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
  const $ = (id)=>document.getElementById(id);
  let allRows = [];

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function api(url, options){
    const r = await fetch(url, {
      headers: { "Content-Type":"application/json" },
      ...options
    });
    const t = await r.text();
    let j;
    try { j = JSON.parse(t); } catch { j = { ok:false, raw:t }; }
    if(!r.ok || j.ok === false) {
      const msg = j.error || j.message || t || ("HTTP " + r.status);
      throw new Error(msg);
    }
    return j;
  }

  // ===== Sprachliste: Europa + Türkisch =====
  // (Du kannst jederzeit weitere Codes hinzufügen)
  const LANGS = [
    ["de","Deutsch"],
    ["en","English"],
    ["fr","Français"],
    ["es","Español"],
    ["it","Italiano"],
    ["pt","Português"],
    ["nl","Nederlands"],
    ["da","Dansk"],
    ["sv","Svenska"],
    ["no","Norsk"],
    ["fi","Suomi"],
    ["is","Íslenska"],
    ["ga","Gaeilge"],
    ["cy","Cymraeg"],
    ["mt","Malti"],
    ["lb","Lëtzebuergesch"],

    ["pl","Polski"],
    ["cs","Čeština"],
    ["sk","Slovenčina"],
    ["sl","Slovenščina"],
    ["hu","Magyar"],
    ["ro","Română"],
    ["bg","Български"],
    ["hr","Hrvatski"],
    ["sr","Српски"],
    ["bs","Bosanski"],
    ["mk","Македонски"],
    ["sq","Shqip"],
    ["el","Ελληνικά"],
    ["tr","Türkçe"],

    ["et","Eesti"],
    ["lv","Latviešu"],
    ["lt","Lietuvių"],
    ["uk","Українська"],
    ["ru","Русский"],
    ["be","Беларуская"],
    ["hy","Հայերեն"],
    ["ka","ქართული"],
    ["az","Azərbaycanca"]
  ];

  function languageSelectHTML(employee_id, current){
    const cur = (current || "de").toString().trim().toLowerCase();
    const opts = LANGS.map(([val,label]) => {
      const sel = (val === cur) ? "selected" : "";
      return `<option value="${esc(val)}" ${sel}>${esc(label)}</option>`;
    }).join("");
    return `<select data-field="language" data-employee-id="${esc(employee_id)}">${opts}</select>`;
  }

  function renderTable(rows){
    const tb = $("tbody");
    if(!tb) return;

    tb.innerHTML = (rows || []).map(r => {
      const id_source = r.id_source === "auto" ? "AUTO" : "manuell";
      const tagClass = r.id_source === "auto" ? "auto" : "manual";
      const emailVal = r.email ? String(r.email) : "";

      return `
        <tr data-row-employee-id="${esc(r.employee_id)}">
          <td class="mono">${esc(r.employee_id)}</td>
          <td>${esc(r.name)}</td>
          <td>
            <input type="text"
                   value="${esc(emailVal)}"
                   placeholder="email@domain.tld"
                   data-field="email"
                   data-employee-id="${esc(r.employee_id)}"
                   style="min-width:220px"/>
          </td>
          <td>
            ${languageSelectHTML(r.employee_id, r.language)}
          </td>
          <td>
            <span class="tag ${tagClass}">${id_source}</span>
          </td>
          <td>${esc(r.staffplan_rows)}</td>
          <td>${esc(r.time_rows)}</td>
          <td>${esc(r.break_rows)}</td>
          <td>
            <button type="button"
                    data-action="save"
                    data-employee-id="${esc(r.employee_id)}">Speichern</button>
            <span class="small muted" data-save-out="${esc(r.employee_id)}"></span>
          </td>
        </tr>
      `;
    }).join("");
  }

  async function loadEmployees(){
    const j = await api("/api/admin/employees");
    allRows = j.rows || [];
    renderTable(allRows);
  }

  // ✅ Auto-Save: Sprache speichern (Change auf Select)
  document.addEventListener("change", async (e) => {
    const sel = e.target;
    if (!sel || !sel.matches("select[data-field='language']")) return;

    const employee_id = sel.dataset.employeeId;
    const language = sel.value;

    if (!employee_id) {
      console.warn("Kein data-employee-id am Select gefunden");
      return;
    }

    sel.disabled = true;

    try {
      await api("/api/admin/employees", {
        method: "PATCH",
        body: JSON.stringify({ employee_id, language })
      });

      sel.style.outline = "2px solid #0a7b2e";
      setTimeout(() => (sel.style.outline = ""), 700);
    } catch (err) {
      sel.style.outline = "2px solid #b10000";
      setTimeout(() => (sel.style.outline = ""), 1200);
      alert("❌ Sprache konnte nicht gespeichert werden: " + err.message);
    } finally {
      sel.disabled = false;
    }
  });

  // ✅ Save-Button je Zeile: Email speichern (und optional Sprache nochmal mitsenden)
  document.addEventListener("click", async (e) => {
    const btn = e.target;
    if (!btn || !btn.matches("button[data-action='save']")) return;

    const employee_id = btn.dataset.employeeId;
    if (!employee_id) return;

    const emailEl = document.querySelector(`input[data-field="email"][data-employee-id="${CSS.escape(employee_id)}"]`);
    const langEl  = document.querySelector(`select[data-field="language"][data-employee-id="${CSS.escape(employee_id)}"]`);
    const outEl   = document.querySelector(`[data-save-out="${CSS.escape(employee_id)}"]`);

    const email = emailEl ? emailEl.value.trim() : null;
    const language = langEl ? langEl.value : null;

    if (outEl) {
      outEl.className = "small muted";
      outEl.textContent = "speichere…";
    }

    btn.disabled = true;
    try {
      await api("/api/admin/employees", {
        method: "PATCH",
        body: JSON.stringify({ employee_id, email: email || null, language })
      });

      if (outEl) {
        outEl.className = "small ok";
        outEl.textContent = "✅ gespeichert";
        setTimeout(()=>{ outEl.textContent=""; outEl.className="small muted"; }, 1200);
      }

      btn.style.outline = "2px solid #0a7b2e";
      setTimeout(() => (btn.style.outline = ""), 700);
    } catch (err) {
      if (outEl) {
        outEl.className = "small bad";
        outEl.textContent = "❌ " + err.message;
      }
      btn.style.outline = "2px solid #b10000";
      setTimeout(() => (btn.style.outline = ""), 1200);
    } finally {
      btn.disabled = false;
    }
  });

  // initial load
  loadEmployees().catch(e => {
    console.error(e);
    alert("Fehler beim Laden: " + e.message);
  });
</script>
  // ---------------- LOGO UPLOAD ----------------
  async function uploadLogo(){
    const fileEl = $("logoFile");
    const out = $("logoOut");
    const img = $("logoPreview");

    if(!fileEl?.files || !fileEl.files[0]){
      out.className = "small bad";
      out.textContent = "❌ Bitte eine PNG-Datei auswählen.";
      return;
    }

    const f = fileEl.files[0];
    if(!f.name.toLowerCase().endsWith(".png")){
      out.className = "small bad";
      out.textContent = "❌ Nur PNG-Dateien erlaubt.";
      return;
    }

    out.className = "small muted";
    out.textContent = "⬆️ Upload läuft…";

    try{
      const fd = new FormData();
      fd.append("file", f);

      const r = await fetch("/api/logo", { method: "POST", body: fd });
      const t = await r.text();
      let j; try { j = JSON.parse(t); } catch { j = { ok:false, raw:t }; }

      if(!r.ok || j.ok === false){
        throw new Error(j.error || j.message || t);
      }

      out.className = "small ok";
      out.textContent = "✅ Logo erfolgreich gespeichert";

      img.style.display = "inline-block";
      img.src = "/api/logo?ts=" + Date.now();
      fileEl.value = "";
    }catch(e){
      out.className = "small bad";
      out.textContent = "❌ " + e.message;
    }
  }

  // ---------------- EMPLOYEES TABLE ----------------
  function renderTable(rows){
    const q = ($("q")?.value || "").trim().toLowerCase();
    const filter = $("filter")?.value || "all";

    let out = rows;

    if(q){
      out = out.filter(r =>
        String(r.employee_id).toLowerCase().includes(q) ||
        String(r.name||"").toLowerCase().includes(q) ||
        String(r.email||"").toLowerCase().includes(q)
      );
    }

    if(filter === "auto") out = out.filter(r => r.id_source === "auto");
    if(filter === "manual") out = out.filter(r => r.id_source !== "auto");
    if(filter === "used") out = out.filter(r => (r.staffplan_rows+r.time_rows+r.break_rows) > 0);

    const tb = $("tbody");
    tb.innerHTML = out.map(r => {
      const emailVal = r.email || "";
      const langVal = r.language || "de";

      return `
        <tr data-employee-id="${esc(r.employee_id)}">
          <td class="mono">${esc(r.employee_id)}</td>
          <td>${esc(r.name)}</td>

          <td>
            <input type="text" data-field="email" value="${esc(emailVal)}" placeholder="email@firma.de" style="min-width:220px"/>
          </td>

<td>
  <select data-field="language"
          data-employee-id="${esc(r.employee_id)}"
          class="lang-select">
    <option value="de">Deutsch</option>
    <option value="en">Englisch</option>
    <option value="fr">Französisch</option>
    <option value="it">Italienisch</option>
    <option value="es">Spanisch</option>
    <option value="pt">Portugiesisch</option>
    <option value="nl">Niederländisch</option>
    <option value="pl">Polnisch</option>
    <option value="cs">Tschechisch</option>
    <option value="sk">Slowakisch</option>
    <option value="hu">Ungarisch</option>
    <option value="ro">Rumänisch</option>
    <option value="bg">Bulgarisch</option>
    <option value="hr">Kroatisch</option>
    <option value="sl">Slowenisch</option>
    <option value="el">Griechisch</option>
    <option value="da">Dänisch</option>
    <option value="sv">Schwedisch</option>
    <option value="fi">Finnisch</option>
    <option value="et">Estnisch</option>
    <option value="lv">Lettisch</option>
    <option value="lt">Litauisch</option>
    <option value="mt">Maltesisch</option>
    <option value="tr">Türkisch</option>
  </select>
</td>
          <td>
            <span class="tag ${r.id_source === 'auto' ? 'auto':'manual'}">
              ${r.id_source === 'auto' ? 'AUTO' : 'manuell'}
            </span>
          </td>
          <td>${esc(r.staffplan_rows)}</td>
          <td>${esc(r.time_rows)}</td>
          <td>${esc(r.break_rows)}</td>

          <td>
            <button class="btnSave" type="button">Speichern</button>
            <div class="small muted saveOut"></div>
          </td>
        </tr>
      `;
    }).join("");

    $("status").textContent = `Zeilen: ${out.length} (gesamt: ${rows.length})`;
  }

  function fillAutoDropdown(rows){
    const autos = rows
      .filter(r => r.id_source === "auto")
      .sort((a,b)=> (b.staffplan_rows+b.time_rows+b.break_rows) - (a.staffplan_rows+a.time_rows+a.break_rows));

    const sel = $("oldId");
    sel.innerHTML = autos.map(r => {
      const used = r.staffplan_rows+r.time_rows+r.break_rows;
      const label = `${r.employee_id} — ${r.name} (Daten: ${used})`;
      return `<option value="${esc(r.employee_id)}">${esc(label)}</option>`;
    }).join("");

    if(!autos.length){
      sel.innerHTML = `<option value="">Keine AUTO_* Einträge gefunden</option>`;
    }
  }

  async function load(){
    $("moveResult").innerHTML = "";
    $("status").textContent = "Lade…";
    const j = await api("/api/admin/employees");
    allRows = j.rows || [];
    renderTable(allRows);
    fillAutoDropdown(allRows);
    wireSaveButtons();
  }

  function wireSaveButtons(){
    document.querySelectorAll("#tbody tr").forEach(tr => {
      const btn = tr.querySelector(".btnSave");
      if(!btn) return;

      btn.addEventListener("click", async () => {
        const employee_id = tr.getAttribute("data-employee-id");
        const email = tr.querySelector('[data-field="email"]')?.value?.trim() ?? "";
        const language = tr.querySelector('[data-field="language"]')?.value ?? "de";
        const out = tr.querySelector(".saveOut");

        out.className = "small muted saveOut";
        out.textContent = "Speichere…";

        try{
          await api("/api/admin/employees", {
            method: "PATCH",
            body: JSON.stringify({
              employee_id,
              email: email === "" ? null : email,
              language
            })
          });

          out.className = "small ok saveOut";
          out.textContent = "✅ gespeichert";

          // optional: lokal updaten, damit nach Filter/Reload korrekt
          const idx = allRows.findIndex(x => x.employee_id === employee_id);
          if(idx >= 0){
            allRows[idx].email = (email === "" ? null : email);
            allRows[idx].language = language;
          }
        }catch(e){
          out.className = "small bad saveOut";
          out.textContent = "❌ " + e.message;
        }
      });
    });
  }

  // ---------------- MOVE AUTO ID ----------------
  async function move(){
    const old_employee_id = $("oldId").value;
    const new_employee_id = $("newId").value.trim();
    const merge = $("merge").value;

    if(!old_employee_id){
      $("moveResult").innerHTML = `<span class="bad">Bitte eine alte AUTO_* ID wählen.</span>`;
      return;
    }
    if(!new_employee_id){
      $("moveResult").innerHTML = `<span class="bad">Bitte neue ID eingeben (z.B. 0815).</span>`;
      return;
    }
    if(new_employee_id.startsWith("AUTO_")){
      $("moveResult").innerHTML = `<span class="bad">Neue ID darf nicht mit AUTO_ beginnen.</span>`;
      return;
    }

    $("moveResult").innerHTML = `<span class="muted">Umhängen läuft…</span>`;

    try{
      const j = await api("/api/admin/employee-id", {
        method:"POST",
        body: JSON.stringify({ old_employee_id, new_employee_id, merge })
      });

      $("moveResult").innerHTML = `
        <div class="ok"><b>✅ Erfolgreich umgehängt</b></div>
        <div class="small">
          <div>Alt: <span class="mono">${esc(j.old_employee_id)}</span> → Neu: <span class="mono">${esc(j.new_employee_id)}</span></div>
          <div>Aktualisiert: staffplan=${esc(j.updated?.staffplan)}, time_entries=${esc(j.updated?.time_entries)}, breaks=${esc(j.updated?.breaks)}</div>
          <div class="muted">Merge-Modus: ${esc(j.merge_mode)}</div>
        </div>
      `;

      await load();
      $("newId").value = "";
    }catch(e){
      $("moveResult").innerHTML = `<span class="bad">❌ Fehler: ${esc(e.message)}</span>`;
    }
  }

  // ---------------- RESET ----------------
  async function doReset(){
    const out = $("resetOut");
    out.className = "small muted";
    out.textContent = "Reset läuft…";

    try {
      const confirm = $("resetConfirm").value.trim();
      const j = await api("/api/admin/reset", {
        method: "POST",
        body: JSON.stringify({ confirm })
      });
      out.className = "small ok";
      out.textContent = "✅ " + (j.note || "Reset erfolgreich");
      await load();
      $("resetConfirm").value = "";
    } catch (e) {
      out.className = "small bad";
      out.textContent = "❌ " + e.message;
    }
  }

  // ---------------- EVENTS ----------------
  $("btnUploadLogo")?.addEventListener("click", uploadLogo);

  $("btnReload")?.addEventListener("click", load);
  $("btnMove")?.addEventListener("click", move);

  $("q")?.addEventListener("input", ()=>renderTable(allRows));
  $("filter")?.addEventListener("change", ()=>renderTable(allRows));

  $("btnResetImport")?.addEventListener("click", doReset);

  load().catch(e=>{
    $("status").innerHTML = `<span class="bad">Fehler: ${esc(e.message)}</span>`;
  });
</script>

</body>
</html>
