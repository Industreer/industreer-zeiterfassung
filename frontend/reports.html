<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Reports – Arbeitszeiten</title>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:1200px}
    h1{margin:0 0 10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,button,label{font-size:14px}
    input,button{padding:10px 12px}
    button{cursor:pointer}
    .card{border:1px solid #ddd;border-radius:10px;padding:16px;margin:14px 0}
    table{border-collapse:collapse;width:100%;margin-top:12px}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left}
    th{background:#fafafa}
    .muted{color:#666}
    .bad{color:#b10000}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .btn{border:1px solid #ddd;border-radius:8px;background:#fff}
    .btn.primary{border-color:#b4d6f0;background:#f5fbff}
  </style>
</head>

<body>

<h1>Reports – Arbeitszeiten</h1>
<div class="muted">
  Abrechnung als Default (nach PO gruppiert) – Clamp-Logik berücksichtigt.
</div>

<!-- FILTER -->
<div class="card">
  <div class="row">
    <label>Von:</label>
    <input id="from" type="date"/>

    <label>Bis:</label>
    <input id="to" type="date"/>

    <label>Code:</label>
    <input id="code" type="text" value="2012" style="width:110px"/>

    <label class="muted" style="margin-left:8px">
      <input id="byPo" type="checkbox" checked/> Abrechnung (nach PO)
    </label>
<label class="muted">Customer PO:</label>
<select id="customerPo" style="padding:10px 12px"></select>

<label class="muted">Interne PO:</label>
<select id="internalPo" style="padding:10px 12px"></select>

  </div>
</div>
<hr style="margin:14px 0;opacity:.25"/>

<div class="row">
  <label>Customer PO:</label>
<select id="customer_po" style="width:220px"></select>

  <label>Internal PO:</label>
  <select id="internal_po" style="width:220px"></select>

  <label class="muted">
    Rundung:
    <input id="round_to" type="text" placeholder="0.25" style="width:70px"/>
  </label>

  <label class="muted">
    Mode:
    <select id="round_mode">
      <option value="nearest">nearest</option>
      <option value="up">up</option>
      <option value="down">down</option>
    </select>
  </label>

  <label class="muted">
    Min/Tag:
    <input id="min_day_hours" type="text" placeholder="1" style="width:70px"/>
  </label>

  <label class="muted">
    Cap/Tag:
    <input id="cap_day_hours" type="text" placeholder="10" style="width:70px"/>
  </label>
</div>

<div class="row" style="margin-top:10px">



<!-- ACTIONS + STATUS -->
<div class="card">
  <div class="row" style="gap:10px">
    <button id="btnLoad" class="btn primary">Summary laden</button>
    <button id="btnSummaryCsv" class="btn">Summary CSV</button>
    <button id="btnDaily" class="btn">Daily laden</button>
<button id="btnWeekly" class="btn">KW laden</button>
<button id="btnWeeklyCsv" class="btn">KW CSV</button>
    <button id="btnDailyCsv" class="btn">Daily CSV</button>
    <button id="btnOpen" class="btn">Offene Zeiten</button>

    <span id="status" class="muted"></span>
  </div>

  <div id="error" class="bad" style="margin-top:10px"></div>
</div>
<!-- TABLE -->
<div class="card">
  <table>
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>
<div class="card">
  <h3 style="margin:0 0 8px">Invoice – Summary</h3>
  <div class="muted small">Billed berücksichtigt Rundung/Min/Cap + optional Travel.</div>

  <table>
    <thead>
      <tr>
        <th>Mitarbeiter</th>
        <th>Customer PO</th>
        <th>Internal PO</th>
        <th>Tage</th>
        <th>Std roh</th>
        <th>Std billed</th>
        <th>Travel roh</th>
        <th>Travel billed</th>
        <th>Bill travel</th>
        <th>Total billed</th>
      </tr>
    </thead>
    <tbody id="invoiceTbody"></tbody>
  </table>
</div>
<div class="card">
  <h3 style="margin:0 0 8px">Invoice – Daily</h3>
  <div class="muted small">Pro Tag pro Mitarbeiter, inkl. Rundung + billed + optional Travel.</div>

  <table>
    <thead>
      <tr>
        <th>Datum</th>
        <th>Mitarbeiter</th>
        <th>Customer PO</th>
        <th>Internal PO</th>
        <th>Std roh</th>
        <th>Std gerundet</th>
        <th>Std billed</th>
        <th>Travel roh</th>
        <th>Travel billed</th>
        <th>Bill travel</th>
        <th>Total billed</th>
      </tr>
    </thead>
    <tbody id="invoiceDailyTbody"></tbody>
  </table>
</div>

<script>
  const $ = (id)=>document.getElementById(id);

  function todayIso(){ return new Date().toISOString().slice(0,10); }

  function setStatus(msg){ $("status").textContent = msg || ""; }
  function setError(msg){ $("error").textContent = msg || ""; }

  function getRange(){
    const from = $("from").value;
    const to = $("to").value;
    if(!from || !to) throw new Error("Bitte Zeitraum wählen.");
    return { from, to };
  }

  async function api(url){
    const code = ($("code").value || "").trim();
    const r = await fetch(url, { headers: { "x-admin-code": code } });
    const t = await r.text();
    let j;
    try { j = JSON.parse(t); } catch { j = { ok:false, error:t }; }
    if(!r.ok || j.ok === false) throw new Error(j.error || ("HTTP " + r.status));
    return j;
  }
async function apiJson(url){
  const code = ($("code").value || "").trim();
  const r = await fetch(url, { headers: { "x-admin-code": code } });
  const t = await r.text();
  let j; try { j = JSON.parse(t); } catch { j = { ok:false, error:t }; }
  if(!r.ok || j.ok === false) throw new Error(j.error || ("HTTP " + r.status));
  return j;
}
async function loadCustomerPos(){
  const j = await api(`/api/admin/customer-pos?limit=300`);
  const sel = $("customerPo");
  sel.innerHTML = `<option value="">(alle)</option>` + (j.rows||[]).map(r =>
    `<option value="${r.customer_po}">${r.customer_po} (${r.cnt})</option>`
  ).join("");
}

async function loadInternalPos(customerPo){
  const sel = $("internalPo");
  sel.innerHTML = `<option value="">(alle)</option>`;
  if(!customerPo) return;

  const j = await api(`/api/admin/internal-pos?customer_po=${encodeURIComponent(customerPo)}`);
  sel.innerHTML = `<option value="">(alle)</option>` + (j.rows||[]).map(r => {
    const v = r.internal_po || "";
    const label = v ? `${v} (${r.cnt})` : `(leer) (${r.cnt})`;
    return `<option value="${v}">${label}</option>`;
  }).join("");
}
function renderInvoiceSummary(rows){
  const tb = $("invoiceTbody");
  if(!rows || !rows.length){
    tb.innerHTML = `<tr><td colspan="10" class="muted">Keine Daten.</td></tr>`;
    return;
  }

  tb.innerHTML = rows.map(r => `
    <tr>
      <td class="mono">${r.employee_id}</td>
      <td class="mono">${r.customer_po || ""}</td>
      <td class="mono">${r.internal_po || ""}</td>
      <td>${r.days ?? ""}</td>
      <td>${Number(r.hours_raw || 0).toFixed(2)}</td>
      <td>${Number(r.hours_billed || 0).toFixed(2)}</td>
      <td>${Number(r.travel_raw || 0).toFixed(2)}</td>
      <td>${Number(r.travel_billed || 0).toFixed(2)}</td>
      <td>${r.bill_travel ? "1" : "0"}</td>
      <td><b>${Number(r.total_billed || 0).toFixed(2)}</b></td>
    </tr>
  `).join("");
}
function renderInvoiceDaily(rows){
  const tb = $("invoiceDailyTbody");
  if(!rows || !rows.length){
    tb.innerHTML = `<tr><td colspan="11" class="muted">Keine Daten.</td></tr>`;
    return;
  }

  tb.innerHTML = rows.map(r => {
    const date = String(r.work_date || r.date || "").slice(0,10);
    return `
      <tr>
        <td class="mono">${date}</td>
        <td class="mono">${r.employee_id}</td>
        <td class="mono">${r.customer_po || ""}</td>
        <td class="mono">${r.internal_po || ""}</td>
        <td>${Number(r.hours_raw || 0).toFixed(2)}</td>
        <td>${Number(r.hours_rounded || 0).toFixed(2)}</td>
        <td>${Number(r.hours_billed || 0).toFixed(2)}</td>
        <td>${Number(r.travel_raw || 0).toFixed(2)}</td>
        <td>${Number(r.travel_billed || 0).toFixed(2)}</td>
        <td>${r.bill_travel ? "1" : "0"}</td>
        <td><b>${Number(r.total_billed || 0).toFixed(2)}</b></td>
      </tr>
    `;
  }).join("");
}

async function loadInvoiceDaily(){
  const from = $("from").value;
  const to = $("to").value;

  const customer_po = $("customer_po")?.value || "";
  const internal_po = $("internal_po")?.value ?? ""; // kann ""

  if(!from || !to) throw new Error("Zeitraum fehlt");
  if(!customer_po){ renderInvoiceDaily([]); return; }

  const round_to = $("round_to") ? $("round_to").value : "";
  const round_mode = $("round_mode") ? $("round_mode").value : "";
  const min_day_hours = $("min_day_hours") ? $("min_day_hours").value : "";
  const cap_day_hours = $("cap_day_hours") ? $("cap_day_hours").value : "";

  const qs = new URLSearchParams();
  qs.set("from", from);
  qs.set("to", to);
  qs.set("customer_po", customer_po);
  qs.set("code", ($("code").value || "").trim());
  qs.set("internal_po", internal_po);

  if(round_to) qs.set("round_to", round_to);
  if(round_mode) qs.set("round_mode", round_mode);
  if(min_day_hours) qs.set("min_day_hours", min_day_hours);
  if(cap_day_hours) qs.set("cap_day_hours", cap_day_hours);

  const url = `/api/admin/invoice/daily?` + qs.toString();
  const j = await apiJson(url);
  renderInvoiceDaily(j.rows || []);
}

async function loadInvoiceSummary(){
  const from = $("from").value;
  const to = $("to").value;

  const customer_po = $("customer_po")?.value || "";
  const internal_po = $("internal_po")?.value ?? ""; // kann ""

  if(!from || !to) throw new Error("Zeitraum fehlt");
  if(!customer_po) { renderInvoiceSummary([]); return; }

  // Optional rounding params (falls du Inputs hast)
  const round_to = $("round_to") ? $("round_to").value : "";
  const round_mode = $("round_mode") ? $("round_mode").value : "";
  const min_day_hours = $("min_day_hours") ? $("min_day_hours").value : "";
  const cap_day_hours = $("cap_day_hours") ? $("cap_day_hours").value : "";

  const qs = new URLSearchParams();
  qs.set("from", from);
  qs.set("to", to);
  qs.set("customer_po", customer_po);
  qs.set("code", ($("code").value || "").trim());

  // internal_po: nur senden, wenn user bewusst gefiltert hat (select existiert immer)
  // Wenn du "alle" willst: value="" -> trotzdem senden ist OK (dein Endpoint kann "" filtern)
  qs.set("internal_po", internal_po);

  if(round_to) qs.set("round_to", round_to);
  if(round_mode) qs.set("round_mode", round_mode);
  if(min_day_hours) qs.set("min_day_hours", min_day_hours);
  if(cap_day_hours) qs.set("cap_day_hours", cap_day_hours);

  const url = `/api/admin/invoice/summary?` + qs.toString();
  const j = await apiJson(url);
  // j.rows enthält schon customer_po/internal_po/hours_raw/hours_billed/travel_raw/travel_billed/bill_travel/total_billed
  renderInvoiceSummary(j.rows || []);
}

  function num(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function render(rows, mode){
    const tb = $("tbody");
    const th = $("thead");

    if(mode === "summary"){
      const include_po = $("byPo").checked;

      th.innerHTML = `
        <tr>
          <th>Mitarbeiter</th>
          ${include_po ? `<th class="mono">Customer PO</th><th class="mono">Interne PO</th>` : ``}
          <th>Tage</th>
          <th>Stunden</th>
        </tr>
      `;

      if(!rows || !rows.length){
        tb.innerHTML = `<tr><td colspan="${include_po ? 5 : 3}" class="muted">Keine Daten.</td></tr>`;
        return;
      }
if(mode === "weekly"){
  th.innerHTML = `
    <tr>
      <th>ISO-Jahr</th>
      <th>KW</th>
      <th>Mitarbeiter</th>
      <th class="mono">Customer PO</th>
      <th class="mono">Interne PO</th>
      <th>Tage</th>
      <th>Stunden</th>
    </tr>
  `;

  if(!rows || !rows.length){
    tb.innerHTML = `<tr><td colspan="7" class="muted">Keine Daten.</td></tr>`;
    return;
  }

  tb.innerHTML = rows.map(r => `
    <tr>
      <td class="mono">${r.isoyear}</td>
      <td class="mono">${r.isoweek}</td>
      <td class="mono">${r.employee_id}</td>
      <td class="mono">${r.customer_po || ""}</td>
      <td class="mono">${r.internal_po || ""}</td>
      <td>${r.days ?? ""}</td>
      <td>${Number(r.hours || 0).toFixed(2)}</td>
    </tr>
  `).join("");
  return;
}

      tb.innerHTML = rows.map(r => `
        <tr>
          <td class="mono">${r.employee_id}</td>
          ${include_po ? `<td class="mono">${r.mapped_customer_po || ""}</td><td class="mono">${r.mapped_internal_po || ""}</td>` : ``}
          <td>${r.days ?? ""}</td>
          <td>${num(r.hours).toFixed(2)}</td>
        </tr>
      `).join("");
      return;
    }

    if(mode === "daily"){
      th.innerHTML = `
        <tr>
          <th>Datum</th>
          <th>Mitarbeiter</th>
          <th class="mono">Customer PO</th>
          <th class="mono">Interne PO</th>
          <th>Start</th>
          <th>Ende</th>
          <th>Pause (min)</th>
          <th>Stunden</th>
        </tr>
      `;

      if(!rows || !rows.length){
        tb.innerHTML = `<tr><td colspan="8" class="muted">Keine Daten.</td></tr>`;
        return;
      }

      tb.innerHTML = rows.map(r => `
        <tr>
          <td class="mono">${String(r.work_date || "").slice(0,10)}</td>
          <td class="mono">${r.employee_id}</td>
          <td class="mono">${r.mapped_customer_po || ""}</td>
          <td class="mono">${r.mapped_internal_po || ""}</td>
          <td class="mono">${r.start_ts ? String(r.start_ts).replace("T"," ").slice(0,19) : ""}</td>
          <td class="mono">${r.end_ts ? String(r.end_ts).replace("T"," ").slice(0,19) : ""}</td>
          <td>${r.break_minutes ?? 0}</td>
          <td>${num(r.hours).toFixed(2)}</td>
        </tr>
      `).join("");
      return;
    }

    if(mode === "open"){
      th.innerHTML = `
        <tr>
          <th>Datum</th>
          <th>Mitarbeiter</th>
          <th class="mono">Customer PO</th>
          <th class="mono">Interne PO</th>
          <th>Start</th>
          <th>Pause (min)</th>
          <th>Status</th>
        </tr>
      `;

      if(!rows || !rows.length){
        tb.innerHTML = `<tr><td colspan="7" class="muted">Keine offenen Zeiten.</td></tr>`;
        return;
      }

      tb.innerHTML = rows.map(r => `
        <tr>
          <td class="mono">${String(r.work_date || "").slice(0,10)}</td>
          <td class="mono">${r.employee_id}</td>
          <td class="mono">${r.mapped_customer_po || ""}</td>
          <td class="mono">${r.mapped_internal_po || ""}</td>
          <td class="mono">${r.start_ts ? String(r.start_ts).replace("T"," ").slice(0,19) : ""}</td>
          <td>${r.break_minutes ?? 0}</td>
          <td class="bad"><b>OFFEN</b> (kein Clock-Out)</td>
        </tr>
      `).join("");
      return;
    }
  }

  async function loadSummary(){
  setError(""); setStatus("Lade Summary…");
  try{
    const {from,to} = getRange();
    const include_po = $("byPo").checked ? 1 : 0;
    const customer_po = $("customerPo")?.value || "";

    let url =
      `/api/admin/report-hours/summary?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&include_po=${include_po}`;
    if(customer_po) url += `&customer_po=${encodeURIComponent(customer_po)}`;

    const j = await api(url); // ✅ DIESE ZEILE FEHLTE

    render(j.rows || [], "summary");
    setStatus(`Summary: ${(j.rows||[]).length} Zeilen`);
  }catch(e){
    setStatus("");
    setError("❌ " + e.message);
    render([], "summary");
  }
}

  async function loadDaily(){
    setError(""); setStatus("Lade Daily…");
    try{
      const {from,to} = getRange();
const customer_po = $("customerPo")?.value || "";
const internal_po = $("internalPo")?.value || "";

let url =
  `/api/admin/report-hours/daily?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;
if(customer_po) url += `&customer_po=${encodeURIComponent(customer_po)}`;
if(internal_po !== "") url += `&internal_po=${encodeURIComponent(internal_po)}`;

      render(j.rows || [], "daily");
      setStatus(`Daily: ${(j.rows||[]).length} Zeilen`);
    }catch(e){
      setStatus("");
      setError("❌ " + e.message);
      render([], "daily");
    }
  }

  function downloadDailyCsv(){
    try{
      const {from,to} = getRange();
      const code = ($("code").value || "").trim();
const customer_po = $("customerPo")?.value || "";
const internal_po = $("internalPo")?.value || "";

let url =
  `/api/admin/report-hours/daily.csv?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&code=${encodeURIComponent(code)}`;
if(customer_po) url += `&customer_po=${encodeURIComponent(customer_po)}`;
if(internal_po !== "") url += `&internal_po=${encodeURIComponent(internal_po)}`;

window.location.href = url;

      window.location.href = url;
    }catch(e){
      setError("❌ " + e.message);
    }
  }

  async function loadOpen(){
    setError(""); setStatus("Lade offene Zeiten…");
    try{
      const {from,to} = getRange();
      const j = await api(`/api/admin/open-sessions?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);
      render(j.rows || [], "open");
      setStatus(`Offen: ${(j.rows||[]).length} Zeilen`);
    }catch(e){
      setStatus("");
      setError("❌ " + e.message);
      render([], "open");
    }
  }
async function loadWeekly(){
  setError(""); setStatus("Lade KW…");
  try{
    const {from,to} = getRange();

    // optional: filter aus dropdowns, falls du die schon eingebaut hast
    const customer_po = $("customerPo")?.value || "";
    const internal_po = $("internalPo")?.value;
    const hasInternal = (internal_po !== undefined); // dropdown existiert?

    let url = `/api/admin/report-hours/weekly?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;
    if(customer_po) url += `&customer_po=${encodeURIComponent(customer_po)}`;
    if(hasInternal) url += `&internal_po=${encodeURIComponent(internal_po || "")}`;

    const j = await api(url);
    render(j.rows || [], "weekly");
    setStatus(`KW: ${(j.rows||[]).length} Zeilen`);
  }catch(e){
    setStatus("");
    setError("❌ " + e.message);
    render([], "weekly");
  }
}

function downloadWeeklyCsv(){
  try{
    const {from,to} = getRange();
    const code = ($("code").value || "").trim();

    const customer_po = $("customerPo")?.value || "";
    const internal_po = $("internalPo")?.value;
    const hasInternal = (internal_po !== undefined);

    let url = `/api/admin/report-hours/weekly.csv?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&code=${encodeURIComponent(code)}`;
    if(customer_po) url += `&customer_po=${encodeURIComponent(customer_po)}`;
    if(hasInternal) url += `&internal_po=${encodeURIComponent(internal_po || "")}`;

    window.location.href = url;
  }catch(e){
    setError("❌ " + e.message);
  }
}

  // Defaults
  $("from").value = $("from").value || todayIso();
  $("to").value = $("to").value || todayIso();

  // Wire buttons
  $("btnLoad").addEventListener("click", loadSummary);
  $("btnSummaryCsv").addEventListener("click", downloadSummaryCsv);
  $("btnDaily").addEventListener("click", loadDaily);
  $("btnDailyCsv").addEventListener("click", downloadDailyCsv);
  $("btnWeekly").addEventListener("click", loadWeekly);
$("btnWeeklyCsv").addEventListener("click", downloadWeeklyCsv);

  $("btnOpen").addEventListener("click", loadOpen);

  // Auto-load (Abrechnung)
  loadSummary();
  // Dropdown init
loadCustomerPos()
  .then(() => loadInternalPos($("customerPo").value))
  .catch(e => setError("❌ " + e.message));

$("customerPo").addEventListener("change", async () => {
  await loadInternalPos($("customerPo").value);
  loadSummary();
});

$("internalPo").addEventListener("change", () => loadDaily());
function qs(params){
  const u = new URLSearchParams();
  Object.entries(params).forEach(([k,v])=>{
    if(v === null || v === undefined) return;
    const s = String(v).trim();
    if(s === "") return;
    u.set(k, s);
  });
  return u.toString();
}

function openCsv(path, params){
  const url = path + "?" + qs(params);
  window.open(url, "_blank");
}

function getCommonParams(){
  return {
    from: $("from").value,
    to: $("to").value,
    code: ($("code").value || "").trim()
  };
}

function getInvoiceParams(){
  const common = getCommonParams();
  return {
    ...common,
    customer_po: ($("customer_po").value || "").trim(),
    internal_po: ($("internal_po").value || "").trim(), // leer erlaubt, wird dann einfach weggelassen
    round_to: ($("round_to").value || "").trim(),
    round_mode: ($("round_mode").value || "nearest").trim(),
    min_day_hours: ($("min_day_hours").value || "").trim(),
    cap_day_hours: ($("cap_day_hours").value || "").trim(),
  };
}

$("btnInvoiceSummaryCsv").addEventListener("click", () => {
  const p = getInvoiceParams();
  if(!p.from || !p.to){ setError("Bitte Zeitraum wählen."); return; }
  if(!p.customer_po){ setError("Bitte Customer PO eingeben."); return; }
  setError("");
  openCsv("/api/admin/invoice/summary.csv", p);
});
async function apiJson(url){
  const code = ($("code").value || "").trim();
  const r = await fetch(url, { headers: { "x-admin-code": code } });
  const t = await r.text();
  let j;
  try { j = JSON.parse(t); } catch { j = { ok:false, error:t }; }
  if(!r.ok || j.ok === false) throw new Error(j.error || ("HTTP " + r.status));
  return j;
}

async function loadCustomerPos(){
  const sel = $("customer_po");
  sel.innerHTML = `<option value="">– Customer PO wählen –</option>`;
  const j = await apiJson("/api/admin/customer-pos?limit=300");
  for(const r of (j.rows || [])){
    const opt = document.createElement("option");
    opt.value = r.customer_po;
    opt.textContent = `${r.customer_po} (${r.cnt})`;
    sel.appendChild(opt);
  }
}

async function loadInternalPos(customerPo){
  const sel = $("internal_po");
  sel.innerHTML = `<option value="">(alle Internal PO)</option>`;
  if(!customerPo) return;

  const j = await apiJson(`/api/admin/internal-pos?customer_po=${encodeURIComponent(customerPo)}`);
  for(const r of (j.rows || [])){
    const opt = document.createElement("option");
    opt.value = r.internal_po;              // kann "" sein
    opt.textContent = r.internal_po ? `${r.internal_po} (${r.cnt})` : `(leer) (${r.cnt})`;
    sel.appendChild(opt);
  }
}
loadCustomerPos()
  .then(()=> loadInternalPos($("customer_po").value))
  .catch(e => setError("❌ " + e.message));
$("btnInvoiceSummaryCsv").addEventListener("click", () => {
  const p = getInvoiceParams();
  if(!p.from || !p.to){ setError("Bitte Zeitraum wählen."); return; }
  if(!p.customer_po){ setError("Bitte Customer PO wählen."); return; }
  setError("");
  openCsv("/api/admin/invoice/summary.csv", p);
});

$("btnInvoiceDailyCsv").addEventListener("click", () => {
  const p = getInvoiceParams();
  if(!p.from || !p.to){ setError("Bitte Zeitraum wählen."); return; }
  if(!p.customer_po){ setError("Bitte Customer PO wählen."); return; }
  setError("");
  openCsv("/api/admin/invoice/daily.csv", p);
});
<!-- =======================================================
U8.12 – Invoice UI (minimal)
Fügt Buttons hinzu für: create-planned, finalize, pdf/csv, export
======================================================= -->
<div style="max-width: 900px; margin: 20px auto; padding: 16px; border: 1px solid #ddd; border-radius: 10px;">
  <h2 style="margin: 0 0 12px 0;">Rechnung (A8)</h2>

  <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
    <label>
      <div>Admin-Code (2012)</div>
      <input id="inv_code" type="password" placeholder="2012" style="width:100%; padding:8px;">
    </label>
    <label>
      <div>Invoice ID (für Laden/Finalize/Export)</div>
      <input id="inv_id" type="text" placeholder="z.B. 1" style="width:100%; padding:8px;">
    </label>

    <label>
      <div>Customer PO</div>
      <input id="inv_customer_po" type="text" placeholder="z.B. 5100860011" style="width:100%; padding:8px;">
    </label>
    <label>
      <div>Internal PO (optional)</div>
      <input id="inv_internal_po" type="text" placeholder="optional (leer lassen)" style="width:100%; padding:8px;">
    </label>

    <label>
      <div>Von (YYYY-MM-DD)</div>
      <input id="inv_from" type="text" placeholder="2026-01-01" style="width:100%; padding:8px;">
    </label>
    <label>
      <div>Bis (YYYY-MM-DD)</div>
      <input id="inv_to" type="text" placeholder="2026-01-31" style="width:100%; padding:8px;">
    </label>

    <label style="grid-column: 1 / span 2;">
      <div>Export-Notiz (optional)</div>
      <input id="inv_note" type="text" placeholder="z.B. PDF+CSV an Buchhaltung übergeben" style="width:100%; padding:8px;">
    </label>
  </div>

  <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top: 12px;">
    <button id="btn_create_planned">Draft erstellen (Planstunden)</button>
    <button id="btn_load">Invoice laden</button>
    <button id="btn_finalize">Finalisieren (Rechnungsnummer)</button>
    <button id="btn_exported">Als exported markieren</button>
    <button id="btn_csv">CSV downloaden</button>
    <button id="btn_pdf">PDF downloaden</button>
  </div>

  <pre id="inv_out" style="margin-top:12px; background:#111; color:#0f0; padding:12px; border-radius:8px; overflow:auto; max-height: 320px;"></pre>
</div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const out = (obj) => { $("inv_out").textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2); };

  function baseUrl(){
    // same origin
    return "";
  }

  function getCode(){
    const c = $("inv_code").value.trim();
    if (!c) throw new Error("Admin-Code fehlt (2012)");
    return c;
  }

  function getBodyCreate(){
    const customer_po = $("inv_customer_po").value.trim();
    const from = $("inv_from").value.trim();
    const to = $("inv_to").value.trim();
    const internal_po = $("inv_internal_po").value; // can be empty string

    if (!customer_po) throw new Error("customer_po fehlt");
    if (!from) throw new Error("from fehlt");
    if (!to) throw new Error("to fehlt");

    const body = { customer_po, from, to };
    if (internal_po != null && internal_po.trim() !== "") body.internal_po = internal_po.trim();
    return body;
  }

  async function api(path, method, body){
    const code = getCode();
    const res = await fetch(baseUrl() + path, {
      method,
      headers: {
        "Content-Type": "application/json",
        "x-admin-code": code
      },
      body: body ? JSON.stringify(body) : undefined
    });

    const ct = res.headers.get("content-type") || "";
    if (ct.includes("application/json")) {
      const j = await res.json();
      if (!res.ok || j.ok === false) throw new Error(j.error || ("HTTP " + res.status));
      return j;
    } else {
      const t = await res.text();
      if (!res.ok) throw new Error(t || ("HTTP " + res.status));
      return t;
    }
  }

  async function loadInvoice(){
    const id = $("inv_id").value.trim();
    if (!id) throw new Error("Invoice ID fehlt");
    const j = await api(`/api/admin/invoices/${encodeURIComponent(id)}`, "GET");
    out(j);
    return j;
  }

  $("btn_create_planned").onclick = async () => {
    try {
      out("Working...");
      const j = await api("/api/admin/invoices/create-planned", "POST", getBodyCreate());
      $("inv_id").value = j.invoice_id;
      out(j);
    } catch (e) { out("ERROR: " + e.message); }
  };

  $("btn_load").onclick = async () => {
    try { out("Working..."); await loadInvoice(); } catch (e) { out("ERROR: " + e.message); }
  };

  $("btn_finalize").onclick = async () => {
    try {
      out("Working...");
      const id = $("inv_id").value.trim();
      if (!id) throw new Error("Invoice ID fehlt");
      const j = await api(`/api/admin/invoices/${encodeURIComponent(id)}/finalize`, "POST");
      out(j);
    } catch (e) { out("ERROR: " + e.message); }
  };

  $("btn_exported").onclick = async () => {
    try {
      out("Working...");
      const id = $("inv_id").value.trim();
      if (!id) throw new Error("Invoice ID fehlt");
      const note = $("inv_note").value.trim();
      const j = await api(`/api/admin/invoices/${encodeURIComponent(id)}/export`, "POST", note ? { note } : {});
      out(j);
    } catch (e) { out("ERROR: " + e.message); }
  };

  $("btn_csv").onclick = async () => {
    try {
      const id = $("inv_id").value.trim();
      if (!id) throw new Error("Invoice ID fehlt");
      const code = getCode();
      window.open(`/api/admin/invoices/${encodeURIComponent(id)}.csv?code=${encodeURIComponent(code)}`, "_blank");
    } catch (e) { out("ERROR: " + e.message); }
  };

  $("btn_pdf").onclick = async () => {
    try {
      const id = $("inv_id").value.trim();
      if (!id) throw new Error("Invoice ID fehlt");
      const code = getCode();
      window.open(`/api/admin/invoices/${encodeURIComponent(id)}.pdf?code=${encodeURIComponent(code)}`, "_blank");
    } catch (e) { out("ERROR: " + e.message); }
  };
})();
</script>

</body>
</html>
