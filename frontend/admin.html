<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Admin – Zeiterfassung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
    .box { background:#fff; padding:20px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    label { display:block; margin-top:10px; font-weight:bold; }
    input,select { width:100%; padding:8px; margin-top:4px; }
    input[readonly] { background:#eee; }
    button { margin-top:15px; padding:10px 14px; background:#1565c0; color:white; border:none; border-radius:4px; cursor:pointer; }
    button.secondary { background:#555; }
    button.danger { background:#c62828; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    th,td { border-bottom:1px solid #ddd; padding:8px; }
    th { background:#eee; }
    tr:hover { background:#f1f1f1; cursor:pointer; }
    .hint { font-size:12px; color:#666; }
    .ok { color:green; font-weight:bold; }
  </style>
</head>
<body>

<h1>Admin – Mitarbeiterverwaltung</h1>

<div class="box">
  <h2>Mitarbeiter bearbeiten</h2>

  <label>Mitarbeiter-ID</label>
  <input id="employee_id">
  <div id="idHint" class="hint"></div>

  <label>Name</label>
  <input id="name">

  <label>E-Mail</label>
  <input id="email">

  <label>Sprache</label>
  <select id="language">
    <option value="de">Deutsch</option>
    <option value="en">Englisch</option>
    <option value="sk">Slowakisch</option>
    <option value="hr">Kroatisch</option>
    <option value="ru">Russisch</option>
    <option value="tr">Türkisch</option>
  </select>

  <button onclick="saveEmployee()">Speichern</button>
  <button class="secondary" onclick="enableIdChange()">ID offiziell ändern</button>

  <div id="status" class="hint"></div>
</div>

<div class="box">
  <h2>Alle Mitarbeiter</h2>
  <table>
    <thead>
      <tr><th>ID</th><th>Name</th><th>E-Mail</th><th>Sprache</th></tr>
    </thead>
    <tbody id="empTable"></tbody>
  </table>
</div>

<script>
let allowIdEdit = false;

async function loadEmployees() {
  const res = await fetch("/api/employees");
  const data = await res.json();
  empTable.innerHTML = "";

  data.forEach(e => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.employee_id}</td>
      <td>${e.name}</td>
      <td>${e.email || ""}</td>
      <td>${e.language}</td>
    `;
    tr.onclick = () => fillForm(e);
    empTable.appendChild(tr);
  });
}

function fillForm(e) {
  employee_id.value = e.employee_id;
  name.value = e.name;
  email.value = e.email || "";
  language.value = e.language || "de";

  allowIdEdit = false;

  if (e.employee_id.startsWith("AUTO_")) {
    employee_id.readOnly = true;
    idHint.textContent = "Automatisch angelegt (ID später änderbar)";
  } else {
    employee_id.readOnly = false;
    idHint.textContent = "";
  }
}

function enableIdChange() {
  if (!employee_id.value.startsWith("AUTO_")) {
    alert("ID ist bereits manuell");
    return;
  }
  if (!confirm("ID wirklich offiziell ändern?")) return;
  employee_id.readOnly = false;
  allowIdEdit = true;
  idHint.textContent = "⚠️ ID-Änderung aktiv – bitte sorgfältig";
}

async function saveEmployee() {
  const payload = {
    employee_id: employee_id.value.trim(),
    name: name.value.trim(),
    email: email.value.trim() || null,
    language: language.value
  };

  const res = await fetch("/api/employees/upsert", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const r = await res.json();
  status.innerHTML = `<span class="ok">✔ Gespeichert</span>`;
  await loadEmployees();
}

loadEmployees();
</script>

</body>
</html>
