<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>INDUSTREER – Mitarbeiter Zeiterfassung</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    padding: 20px;
  }
  .box {
    background: #fff;
    padding: 20px;
    max-width: 600px;
    margin: auto;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  h2 {
    margin-top: 0;
  }
  .logo {
    max-width: 200px;
    display: block;
    margin: 0 auto 15px auto;
  }
  label {
    display: block;
    margin-top: 10px;
  }
  input, select, textarea, button {
    width: 100%;
    margin-top: 5px;
    padding: 8px;
    font-size: 14px;
  }
  button {
    margin-top: 10px;
    cursor: pointer;
  }
  .status {
    margin-top: 15px;
    font-weight: bold;
  }
  .timer {
    background: #eef3f8;
    padding: 10px;
    margin-top: 15px;
    border-radius: 4px;
  }
</style>
</head>

<body>

<div class="box">

  <!-- LOGO -->
  <img src="/api/logo" class="logo" onerror="this.style.display='none'" />

  <h2>Mitarbeiter Zeiterfassung</h2>

  <!-- LOGIN -->
  <label>Mitarbeiter-ID</label>
  <input id="employeeId" placeholder="z. B. 1001" />
  <button onclick="login()">Anmelden</button>

  <!-- WELCOME -->
  <div id="welcome" style="display:none;">
    <p><strong>Willkommen <span id="employeeName"></span></strong></p>
  </div>

  <!-- TIMER -->
  <div id="timerBox" class="timer" style="display:none;">
    <div>Arbeitsbeginn: <span id="startTimeText"></span></div>
    <div>Laufzeit: <span id="elapsed">00:00:00</span></div>
  </div>

  <!-- ACTIONS -->
  <div id="actions" style="display:none;">

    <button onclick="startWork()">Arbeitsbeginn</button>
    <button onclick="endWork()">Arbeitsende</button>

    <button onclick="startBreak()">Raucherpause starten</button>
    <button onclick="endBreak()">Raucherpause beenden</button>

    <label>Tätigkeit</label>
    <select id="activity">
      <option value="">– bitte wählen –</option>
      <option>Montage</option>
      <option>Inbetriebnahme</option>
      <option>E-Installation</option>
      <option>Reisezeit</option>
      <option value="__custom__">Eigener Text …</option>
    </select>

    <textarea id="customActivity" placeholder="Eigene Tätigkeit eingeben"
              style="display:none;"></textarea>

    <button onclick="printLastWeek()">Stundenzettel letzte KW drucken</button>

    <label>Kalenderwoche</label>
    <input id="kwInput" placeholder="z. B. CW49" />
    <button onclick="printSelectedWeek()">Stundenzettel für KW drucken</button>

  </div>

  <div id="status" class="status"></div>

</div>

<script>
let currentEmployee = null;
let timerInterval = null;

// ---------------- LOGIN ----------------
async function login() {
  const id = employeeId.value.trim();
  if (!id) return alert("Bitte Mitarbeiter-ID eingeben");

  const r = await fetch(`/api/employee/${encodeURIComponent(id)}`);
  const j = await r.json();
  if (!j.ok) return alert("Mitarbeiter nicht gefunden");

  currentEmployee = j.employee;
  employeeName.innerText = currentEmployee.name;
  welcome.style.display = "block";
  actions.style.display = "block";

  checkRunningTimer();
}

// ---------------- TIMER CHECK ----------------
async function checkRunningTimer() {
  const r = await fetch(`/api/time/current/${currentEmployee.employee_id}`);
  const j = await r.json();
  if (j.ok) {
    startTimer(j.start_time);
  }
}

// ---------------- TIMER ----------------
function startTimer(startISO) {
  const start = new Date(startISO);
  timerBox.style.display = "block";
  startTimeText.innerText = start.toLocaleTimeString("de-DE");

  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const diff = Math.floor((Date.now() - start) / 1000);
    const h = String(Math.floor(diff / 3600)).padStart(2,"0");
    const m = String(Math.floor((diff % 3600) / 60)).padStart(2,"0");
    const s = String(diff % 60).padStart(2,"0");
    elapsed.innerText = `${h}:${m}:${s}`;
  }, 1000);
}

// ---------------- WORK ----------------
async function startWork() {
  const r = await fetch("/api/time/start", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ employee_id: currentEmployee.employee_id })
  });
  const j = await r.json();
  if (!j.ok) return alert(j.error || "Fehler");

  startTimer(j.start_time);
  status.innerText = "Arbeitsbeginn erfasst";
}

async function endWork() {
  let act = activity.value;
  if (act === "__custom__") {
    act = customActivity.value.trim();
  }
  if (!act) act = "Arbeitszeit";

  const r = await fetch("/api/time/end", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      employee_id: currentEmployee.employee_id,
      activity: act
    })
  });
  const j = await r.json();
  if (!j.ok) return alert(j.error || "Fehler");

  timerBox.style.display = "none";
  clearInterval(timerInterval);
  status.innerText =
    `Arbeitsende erfasst (${j.net_hours} Std, Pause ${j.break_minutes} Min)`;
}

// ---------------- BREAKS ----------------
async function startBreak() {
  await fetch("/api/break/start", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ employee_id: currentEmployee.employee_id })
  });
  status.innerText = "Raucherpause gestartet";
}

async function endBreak() {
  await fetch("/api/break/end", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ employee_id: currentEmployee.employee_id })
  });
  status.innerText = "Raucherpause beendet";
}

// ---------------- PDF ----------------
function printLastWeek() {
  const d = new Date();
  d.setDate(d.getDate() - 7);
  const kw = "CW" + getWeek(d);
  window.open(`/api/pdf/timesheet/${currentEmployee.employee_id}/${kw}/`, "_blank");
}

function printSelectedWeek() {
  const kw = kwInput.value.trim();
  if (!kw) return alert("KW eingeben");
  window.open(`/api/pdf/timesheet/${currentEmployee.employee_id}/${kw}/`, "_blank");
}

// ---------------- HELPERS ----------------
activity.addEventListener("change", () => {
  customActivity.style.display = activity.value === "__custom__" ? "block" : "none";
});

function getWeek(d) {
  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}
</script>

</body>
</html>
