<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Zeiterfassung Terminal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { background:#111; color:#fff; font-family:Arial; text-align:center; }
.card { background:#222; padding:20px; border-radius:8px; max-width:350px; margin:auto; }
input,select,button { width:100%; padding:12px; margin:8px 0; font-size:1.1em; }
button { cursor:pointer; }
.success { color:#0f0; font-size:1.3em; }
</style>
</head>
<body>

<div class="card" id="login">
  <h2>Mitarbeiter Anmeldung</h2>
  <input id="empId" placeholder="Mitarbeiter-ID">
  <button onclick="login()">Anmelden</button>
</div>

<div class="card" id="project" style="display:none">
  <h2 id="welcome"></h2>
  <select id="projectSelect"></select>
  <button onclick="showActions()">Projekt bestätigen</button>
</div>

<div class="card" id="actions" style="display:none"></div>

<script>
let employee = null;
let projectId = null;

async function login() {
  const id = empId.value.trim();
  const r = await fetch(`/api/terminal/login?employee_id=${id}`);
  const d = await r.json();
  if (!d.ok) return alert("Mitarbeiter nicht gefunden");
  employee = d.employee;
  loadProjects();
}

async function loadProjects() {
  const today = new Date().toISOString().slice(0,10);
  const r = await fetch(`/api/allowed-projects?employee_id=${employee.employee_id}&date=${today}`);
  const d = await r.json();
  projectSelect.innerHTML="";
  d.projects.forEach(p=>{
    const o=document.createElement("option");
    o.value=p.project_id;
    o.text=`${p.project_id} – ${p.name}`;
    projectSelect.appendChild(o);
  });
  welcome.innerText = `Hallo ${employee.name}`;
  login.style.display="none";
  project.style.display="block";
}

function showActions() {
  projectId = projectSelect.value;
  project.style.display="none";
  actions.style.display="block";
  actions.innerHTML = `
    <div class="success">${employee.name}<br>${projectId}</div>
    <button onclick="send('IN')">Arbeitsbeginn</button>
    <button onclick="send('PAUSE')">Pause</button>
    <button onclick="send('OUT')">Arbeitsende</button>
  `;
}

async function send(type) {
  await fetch("/api/time-event", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      employee_id: employee.employee_id,
      project_id: projectId,
      event_type: type
    })
  });
  actions.innerHTML = `<div class="success">Buchung gespeichert</div>`;
  setTimeout(()=>location.reload(),3000);
}
</script>

</body>
</html>
