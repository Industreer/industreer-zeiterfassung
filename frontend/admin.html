<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin ‚Äì Mitarbeiter IDs</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:1200px}
    h1{margin:0 0 10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:10px 12px;font-size:14px}
    input[type="text"]{min-width:260px}
    button{cursor:pointer}
    .card{border:1px solid #ddd;border-radius:10px;padding:16px;margin:14px 0}
    .muted{color:#666}
    table{border-collapse:collapse;width:100%;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;vertical-align:top}
    th{background:#fafafa}
    .tag{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid #ddd}
    .tag.auto{border-color:#f0b4b4;background:#fff5f5}
    .tag.manual{border-color:#b4d6f0;background:#f5fbff}
    .ok{color:#0a7b2e}
    .bad{color:#b10000}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .small{font-size:12px}
  </style>
</head>
<body>
  <h1>Admin ‚Äì Mitarbeiter IDs (Hybrid)</h1>
  <div class="muted">Ziel: AUTO_* IDs auf echte Mitarbeiter-IDs umh√§ngen (inkl. Staffplan/Zeiten/Pausen).</div>

  <div class="card">
    <div class="row">
      <button id="btnReload">Neu laden</button>
      <label class="muted">Suche:</label>
      <input id="q" type="text" placeholder="Name oder ID (z.B. Damir, AUTO_, 0815)"/>
      <label class="muted">Filter:</label>
      <select id="filter">
        <option value="all">Alle</option>
        <option value="auto">Nur AUTO_* (id_source=auto)</option>
        <option value="manual">Nur manuell</option>
        <option value="used">Mit Daten (staffplan/time/breaks > 0)</option>
      </select>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">AUTO_* umh√§ngen</h3>
    <div class="muted small" style="margin-bottom:10px">
      Vorgehen: <b>alte AUTO_‚Ä¶</b> ausw√§hlen ‚Üí <b>neue echte ID</b> eingeben ‚Üí ‚ÄûUmh√§ngen‚Äú.
      Wenn die neue ID schon existiert, wird zusammengef√ºhrt (optional ‚Äûalte Daten √ºbernehmen‚Äú).
    </div>

    <div class="row">
      <label>Alte ID (AUTO_*):</label>
      <select id="oldId"></select>

      <label>Neue ID:</label>
      <input id="newId" type="text" placeholder="z.B. 0815"/>

      <label class="muted">Merge-Modus:</label>
      <select id="merge">
        <option value="keep_new">keep_new (bestehende neue Daten behalten)</option>
        <option value="keep_old">keep_old (Name/Email/Sprache von alt √ºbernehmen)</option>
      </select>

      <button id="btnMove">Umh√§ngen</button>
    </div>

    <div id="moveResult" class="small" style="margin-top:10px"></div>
  </div>

  <!-- ‚úÖ Reset-Tools (damit dein vorhandenes JS nicht crasht) -->
  <div class="card" id="resetTools">
    <h3 style="margin:0 0 8px">Tools: Import-Daten zur√ºcksetzen</h3>
    <div class="muted small" style="margin-bottom:10px">
      L√∂scht Import-Daten/Zuordnungen serverseitig (je nach Implementierung). Bitte vorsichtig benutzen.
    </div>
    <div class="row">
      <label class="muted">Best√§tigung:</label>
      <input id="resetConfirm" type="text" placeholder="z.B. RESET oder Code (je nach Backend)"/>
      <button id="btnResetImport">Reset ausf√ºhren</button>
      <span id="resetOut" class="small muted"></span>
    </div>
  </div>

  <!-- ‚úÖ Staffplan Tools (sichtbar: Download + Upload) -->
  <div class="card" id="staffplanTools">
    <h3 style="margin:0 0 8px">Staffplan Tools</h3>
    <div class="muted small" style="margin-bottom:10px">
      Fallback, falls SharePoint/Graph gerade nicht l√§uft: Download manuell triggern oder Excel hochladen.
      Aktionen erfordern den Code <b>2012</b>.
    </div>

    <div class="row">
      <button id="btnDownloadStaffplan">üì• Staffplan manuell herunterladen</button>

      <input id="staffplanFile" type="file"
             accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"/>

      <button id="btnUploadStaffplan">‚¨ÜÔ∏è Staffplan Excel hochladen</button>

      <span id="dlOut" class="small muted"></span>
    </div>

    <div id="uploadOut" class="small" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Mitarbeiter√ºbersicht</h3>
    <div class="muted small">Hinweis: In der Liste siehst du auch Dubletten (gleicher Name, unterschiedliche IDs). Das ist normal ‚Äì genau daf√ºr ist das Umh√§ngen da.</div>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Sprache</th>
          <th>Quelle</th>
          <th>Staffplan</th>
          <th>Zeiten</th>
          <th>Pausen</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  let allRows = [];

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function api(url, options){
    const r = await fetch(url, {
      headers: { "Content-Type":"application/json" },
      ...options
    });
    const t = await r.text();
    let j;
    try { j = JSON.parse(t); } catch { j = { ok:false, raw:t }; }
    if(!r.ok || j.ok === false) {
      const msg = j.error || j.message || t || ("HTTP " + r.status);
      throw new Error(msg);
    }
    return j;
  }

  function renderTable(rows){
    const qEl = $("q");
    const filterEl = $("filter");
    const q = (qEl ? qEl.value : "").trim().toLowerCase();
    const filter = filterEl ? filterEl.value : "all";

    let out = rows;

    if(q){
      out = out.filter(r =>
        String(r.employee_id).toLowerCase().includes(q) ||
        String(r.name||"").toLowerCase().includes(q) ||
        String(r.email||"").toLowerCase().includes(q)
      );
    }

    if(filter === "auto") out = out.filter(r => r.id_source === "auto");
    if(filter === "manual") out = out.filter(r => r.id_source !== "auto");
    if(filter === "used") out = out.filter(r => (r.staffplan_rows+r.time_rows+r.break_rows) > 0);

    const tb = $("tbody");
    if(tb){
      tb.innerHTML = out.map(r => `
        <tr>
          <td class="mono">${esc(r.employee_id)}</td>
          <td>${esc(r.name)}</td>
          <td>${r.email ? esc(r.email) : '<span class="muted">‚Äì</span>'}</td>
          <td>${esc(r.language || 'de')}</td>
          <td>
            <span class="tag ${r.id_source === 'auto' ? 'auto':'manual'}">
              ${r.id_source === 'auto' ? 'AUTO' : 'manuell'}
            </span>
          </td>
          <td>${esc(r.staffplan_rows)}</td>
          <td>${esc(r.time_rows)}</td>
          <td>${esc(r.break_rows)}</td>
        </tr>
      `).join("");
    }

    const st = $("status");
    if(st) st.textContent = `Zeilen: ${out.length} (gesamt: ${rows.length})`;
  }

  function fillAutoDropdown(rows){
    const autos = rows
      .filter(r => r.id_source === "auto")
      .sort((a,b)=> (b.staffplan_rows+b.time_rows+b.break_rows) - (a.staffplan_rows+a.time_rows+a.break_rows));

    const sel = $("oldId");
    if(!sel) return;

    sel.innerHTML = autos.map(r => {
      const used = r.staffplan_rows+r.time_rows+r.break_rows;
      const label = `${r.employee_id} ‚Äî ${r.name} (Daten: ${used})`;
      return `<option value="${esc(r.employee_id)}">${esc(label)}</option>`;
    }).join("");

    if(!autos.length){
      sel.innerHTML = `<option value="">Keine AUTO_* Eintr√§ge gefunden</option>`;
    }
  }

  async function load(){
    const mr = $("moveResult");
    if(mr) mr.innerHTML = "";

    const st = $("status");
    if(st) st.textContent = "Lade‚Ä¶";

    const j = await api("/api/admin/employees");
    allRows = j.rows || [];
    renderTable(allRows);
    fillAutoDropdown(allRows);
  }

  async function move(){
    const oldIdEl = $("oldId");
    const newIdEl = $("newId");
    const mergeEl = $("merge");
    const resEl = $("moveResult");

    const old_employee_id = oldIdEl ? oldIdEl.value : "";
    const new_employee_id = newIdEl ? newIdEl.value.trim() : "";
    const merge = mergeEl ? mergeEl.value : "keep_new";

    if(!old_employee_id){
      if(resEl) resEl.innerHTML = `<span class="bad">Bitte eine alte AUTO_* ID w√§hlen.</span>`;
      return;
    }
    if(!new_employee_id){
      if(resEl) resEl.innerHTML = `<span class="bad">Bitte neue ID eingeben (z.B. 0815).</span>`;
      return;
    }
    if(new_employee_id.startsWith("AUTO_")){
      if(resEl) resEl.innerHTML = `<span class="bad">Neue ID darf nicht mit AUTO_ beginnen.</span>`;
      return;
    }

    if(resEl) resEl.innerHTML = `<span class="muted">Umh√§ngen l√§uft‚Ä¶</span>`;

    try{
      const j = await api("/api/admin/employee-id", {
        method:"POST",
        body: JSON.stringify({ old_employee_id, new_employee_id, merge })
      });

      if(resEl){
        resEl.innerHTML = `
          <div class="ok"><b>‚úÖ Erfolgreich umgeh√§ngt</b></div>
          <div class="small">
            <div>Alt: <span class="mono">${esc(j.old_employee_id)}</span> ‚Üí Neu: <span class="mono">${esc(j.new_employee_id)}</span></div>
            <div>Aktualisiert: staffplan=${esc(j.updated?.staffplan)}, time_entries=${esc(j.updated?.time_entries)}, breaks=${esc(j.updated?.breaks)}</div>
            <div class="muted">Merge-Modus: ${esc(j.merge_mode)}</div>
          </div>
        `;
      }

      await load();
      if(newIdEl) newIdEl.value = "";
    }catch(e){
      if(resEl) resEl.innerHTML = `<span class="bad">‚ùå Fehler: ${esc(e.message)}</span>`;
    }
  }

  // ===== Tools: Reset Import-Daten =====
  async function doReset(){
    const out = $("resetOut");
    if(out){
      out.className = "small muted";
      out.textContent = "Reset l√§uft‚Ä¶";
    }

    try {
      const confirmEl = $("resetConfirm");
      const confirm = confirmEl ? confirmEl.value.trim() : "";
      const j = await api("/api/admin/reset", {
        method: "POST",
        body: JSON.stringify({ confirm })
      });

      if(out){
        out.className = "small ok";
        out.textContent = "‚úÖ " + (j.note || "Reset erfolgreich");
      }

      await load();
      if(confirmEl) confirmEl.value = "";
    } catch (e) {
      if(out){
        out.className = "small bad";
        out.textContent = "‚ùå " + e.message;
      }
    }
  }

  // ===== Tools: Staffplan Download (Code 2012) =====
  async function downloadStaffplan(){
    const out = $("dlOut");
    if(out){
      out.className = "small muted";
      out.textContent = "";
    }

    const code = prompt("Best√§tigungscode eingeben (2012):");
    if (!code) return;

    if (code.trim() !== "2012") {
      if(out){
        out.className = "small bad";
        out.textContent = "‚ùå Falscher Code.";
      }
      return;
    }

    if(out){
      out.className = "small muted";
      out.textContent = "‚¨áÔ∏è Download startet‚Ä¶";
    }

    // Download im Browser ausl√∂sen (dein vorhandener Endpoint)
    window.location.href = `/api/staffplan/download?code=${encodeURIComponent(code.trim())}`;
  }

  // ===== Tools: Staffplan Upload (Code 2012) =====
  async function uploadStaffplan(){
    const fileEl = $("staffplanFile");
    const out = $("uploadOut");
    const dlOut = $("dlOut");

    if(out){
      out.className = "small muted";
      out.textContent = "";
    }

    if(!fileEl || !fileEl.files || !fileEl.files[0]){
      if(out){
        out.className = "small bad";
        out.textContent = "‚ùå Bitte zuerst eine .xlsx Datei ausw√§hlen.";
      }
      return;
    }

    const code = prompt("Best√§tigungscode eingeben (2012):");
    if (!code) return;

    if (code.trim() !== "2012") {
      if(out){
        out.className = "small bad";
        out.textContent = "‚ùå Falscher Code.";
      }
      return;
    }

    if(dlOut){
      dlOut.className = "small muted";
      dlOut.textContent = "‚¨ÜÔ∏è Upload l√§uft‚Ä¶";
    }

    try{
      const fd = new FormData();
      fd.append("file", fileEl.files[0]);
      fd.append("code", code.trim());
      // Erwarteter Backend-Endpoint (multipart/form-data)
      const r = await fetch(`/api/admin/staffplan/upload?code=${encodeURIComponent(code.trim())}`, { method:"POST", body: fd });
      const t = await r.text();
      let j; try { j = JSON.parse(t); } catch { j = { ok:false, raw:t }; }

      if(!r.ok || j.ok === false){
        throw new Error(j.error || j.message || t || ("HTTP " + r.status));
      }

      if(out){
        out.className = "small ok";
        out.textContent = "‚úÖ " + (j.message || "Upload/Import gestartet");
      }
      if(dlOut) dlOut.textContent = "";

      await load();
      fileEl.value = "";
    }catch(e){
      if(out){
        out.className = "small bad";
        out.textContent = "‚ùå " + e.message;
      }
      if(dlOut) dlOut.textContent = "";
    }
  }

  // ===== Sichere Event-Bindings (kein Crash, auch wenn Elemente fehlen) =====
  const btnReload = $("btnReload");
  if(btnReload) btnReload.addEventListener("click", load);

  const btnMove = $("btnMove");
  if(btnMove) btnMove.addEventListener("click", move);

  const qEl = $("q");
  if(qEl) qEl.addEventListener("input", ()=>renderTable(allRows));

  const filterEl = $("filter");
  if(filterEl) filterEl.addEventListener("change", ()=>renderTable(allRows));

  const btnReset = $("btnResetImport");
  if(btnReset) btnReset.addEventListener("click", doReset);

  const btnDl = $("btnDownloadStaffplan");
  if(btnDl) btnDl.addEventListener("click", downloadStaffplan);

  const btnUp = $("btnUploadStaffplan");
  if(btnUp) btnUp.addEventListener("click", uploadStaffplan);

  load().catch(e=>{
    const st = $("status");
    if(st) st.innerHTML = `<span class="bad">Fehler: ${esc(e.message)}</span>`;
  });
</script>
</body>
</html>
