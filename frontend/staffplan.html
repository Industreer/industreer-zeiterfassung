<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Staffplan – Abwesenheiten + Edit</title>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:1500px}
    h1{margin:0 0 10px}
    .muted{color:#666}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:10px 12px;font-size:14px}
    input[type="date"]{min-width:170px}
    input[type="number"]{width:110px}
    button{cursor:pointer}
    .btn{border:1px solid #ddd;border-radius:8px;background:#fff}
    .btn.primary{border-color:#b4d6f0;background:#f5fbff}
    .btn.danger{border-color:#f0b4b4;background:#fff5f5}
    .card{border:1px solid #ddd;border-radius:10px;padding:16px;margin:14px 0}
    .ok{color:#0a7b2e}
    .bad{color:#b10000}
    .small{font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

    table{border-collapse:collapse;width:100%;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;vertical-align:top}
    th{background:#fafafa;position:sticky;top:0;z-index:1}

    .pill{
      display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid #ddd;background:#fff;white-space:nowrap
    }
    .pill.sick{border-color:#f0b4b4;background:#fff5f5}
    .pill.vac{border-color:#ffe1a6;background:#fff9e6}

    tr.sick{background:#fff1f1}
    tr.vac{background:#fff9e6}
    tr.sick td{border-bottom-color:#f3c3c3}
    tr.vac td{border-bottom-color:#f1e2b8}

    .cell-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .savehint{color:#666;font-size:12px}
  </style>
</head>
<body>

  <div class="row" style="justify-content:space-between;align-items:flex-start">
    <div>
      <h1>Staffplan – Abwesenheiten + Edit</h1>
      <div class="muted">
        Rot = krank, Gelb = Urlaub. Editierbar: <b>planned_hours</b>.
      </div>
      <div class="muted small">
        Admin-Schutz aktiv (Header <span class="mono">x-admin-code: 2012</span>).
      </div>
    </div>
    <div class="row">
      <a class="btn" style="text-decoration:none;display:inline-block;padding:10px 12px" href="/admin">← Admin</a>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <label class="muted">von:</label>
      <input id="from" type="date">
      <label class="muted">bis:</label>
      <input id="to" type="date">
      <button id="btnLoad" class="btn primary">Laden</button>

      <label class="muted">Filter:</label>
      <select id="filter">
        <option value="all">Alle</option>
        <option value="sick">Nur krank</option>
        <option value="vacation">Nur Urlaub</option>
        <option value="none">Nur ohne Abwesenheit</option>
      </select>

      <input id="q" type="text" placeholder="Suche (Mitarbeiter/Kunde/Projekt)" style="min-width:320px">
      <span id="status" class="muted"></span>
    </div>

    <div class="muted small" style="margin-top:10px">
      Tipp: Stunden ändern → <b>Speichern</b> drücken.
    </div>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>Mitarbeiter</th>
          <th>Kunde</th>
          <th>POs</th>
          <th>Projekt</th>
          <th>Stunden</th>
          <th>Abwesenheit</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div id="statusBottom" class="muted small" style="margin-top:10px"></div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function todayIso(){
    const fmt = new Intl.DateTimeFormat("en-CA", {
      timeZone: "Europe/Berlin",
      year: "numeric", month: "2-digit", day: "2-digit",
    });
    return fmt.format(new Date());
  }

  function addDaysIso(iso, days){
    const d = new Date(iso + "T00:00:00.000Z");
    d.setUTCDate(d.getUTCDate() + days);
    return d.toISOString().slice(0,10);
  }

  async function api(url, options){
    const r = await fetch(url, {
      headers: {
        "Content-Type":"application/json",
        "x-admin-code":"2012"
      },
      ...options
    });
    const t = await r.text();
    let j;
    try { j = JSON.parse(t); } catch { j = { ok:false, raw:t }; }
    if(!r.ok || j.ok === false) {
      const msg = j.error || j.message || t || ("HTTP " + r.status);
      throw new Error(msg);
    }
    return j;
  }

  function pill(type){
    if(type === "sick") return `<span class="pill sick">Krank</span>`;
    if(type === "vacation") return `<span class="pill vac">Urlaub</span>`;
    return `<span class="muted small">–</span>`;
  }

  let allRows = [];

  function rowClass(absence_type){
    if(absence_type === "sick") return "sick";
    if(absence_type === "vacation") return "vac";
    return "";
  }

  function render(rows){
    const filter = $("filter")?.value || "all";
    const q = ($("q")?.value || "").trim().toLowerCase();

    let out = rows || [];

    if(filter === "sick") out = out.filter(r => r.absence_type === "sick");
    if(filter === "vacation") out = out.filter(r => r.absence_type === "vacation");
    if(filter === "none") out = out.filter(r => !r.absence_type);

    if(q){
      out = out.filter(r => {
        const hay = [
          r.employee_name, r.customer, r.project_short,
          r.customer_po, r.internal_po
        ].map(x => String(x||"").toLowerCase()).join(" ");
        return hay.includes(q);
      });
    }

    const tb = $("tbody");
    if(!tb) return;

    tb.innerHTML = out.map((r, idx) => {
      const key = {
        employee_id: r.employee_id,
        work_date: (r.work_date ? String(r.work_date).slice(0,10) : ""),
        customer_po: r.customer_po || "",
        internal_po: r.internal_po || "",
        project_short: r.project_short || ""
      };

      const hrs = (r.planned_hours ?? "");
      return `
        <tr class="${rowClass(r.absence_type)}">
          <td class="mono">${esc(key.work_date)}</td>
          <td>${esc(r.employee_name || "")}<div class="muted small mono">${esc(r.employee_id)}</div></td>
          <td>${esc(r.customer || "")}</td>
          <td class="small">
            <div>cust_po: <span class="mono">${esc(r.customer_po || "")}</span></div>
            <div>int_po: <span class="mono">${esc(r.internal_po || "")}</span></div>
          </td>
          <td>${esc(r.project_short || "")}</td>
          <td>
            <input
              type="number" step="0.25" min="0"
              data-action="hrs"
              data-idx="${idx}"
              value="${esc(hrs)}"
            />
            <div class="savehint">z.B. 7.5</div>
          </td>
          <td>${pill(r.absence_type)}</td>
          <td>
            <div class="cell-actions">
              <button class="btn primary" data-action="save" data-idx="${idx}">Speichern</button>
              <span class="small muted" data-action="msg" data-idx="${idx}"></span>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    const txt = `Zeilen: ${out.length} (gesamt: ${(rows||[]).length})`;
    if($("statusBottom")) $("statusBottom").textContent = txt;
    if($("status")) $("status").textContent = txt;
  }

  function setMsg(idx, text, ok){
    const el = document.querySelector(`span[data-action="msg"][data-idx="${idx}"]`);
    if(!el) return;
    el.className = "small " + (ok===true ? "ok" : ok===false ? "bad" : "muted");
    el.textContent = text || "";
  }

  async function load(){
    const from = $("from")?.value || "";
    const to = $("to")?.value || "";

    if(!from || !to){
      alert("Bitte von/bis setzen.");
      return;
    }
    if(to < from){
      alert("bis darf nicht vor von liegen.");
      return;
    }

    if($("status")) $("status").textContent = "Lade…";
    const j = await api(`/api/admin/staffplan/with-absences?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);
    allRows = j.rows || [];
    render(allRows);
  }

  async function saveHours(idx){
    const r = allRows[idx];
    if(!r){
      setMsg(idx, "Row fehlt", false);
      return;
    }

    const inp = document.querySelector(`input[data-action="hrs"][data-idx="${idx}"]`);
    const planned_hours_raw = inp ? inp.value : "";

    let planned_hours = null;
    if(String(planned_hours_raw).trim() !== ""){
      const n = Number(planned_hours_raw);
      if(!isFinite(n) || n < 0){
        setMsg(idx, "Ungültige Stunden", false);
        return;
      }
      planned_hours = n;
    }

    const payload = {
      employee_id: r.employee_id,
      work_date: String(r.work_date).slice(0,10),
      customer_po: r.customer_po || null,
      internal_po: r.internal_po || null,
      project_short: r.project_short || null,
      planned_hours
    };

    try{
      setMsg(idx, "Speichern…", null);
      await api("/api/admin/staffplan/planned-hours", {
        method: "PATCH",
        body: JSON.stringify(payload)
      });
      setMsg(idx, "✅ gespeichert", true);

      // local update
      r.planned_hours = planned_hours;

    }catch(e){
      setMsg(idx, "❌ " + e.message, false);
    }
  }

  // Events
  $("btnLoad")?.addEventListener("click", ()=> load().catch(e => alert("❌ " + e.message)));
  $("filter")?.addEventListener("change", ()=> render(allRows));
  $("q")?.addEventListener("input", ()=> render(allRows));

  document.addEventListener("click", (e) => {
    const el = e.target;
    if(!el) return;
    if(el.matches("button[data-action='save'][data-idx]")){
      const idx = parseInt(el.dataset.idx, 10);
      saveHours(idx);
    }
  });

  // Init defaults
  const t = todayIso();
  if($("from")) $("from").value = t;
  if($("to")) $("to").value = addDaysIso(t, 6);

  // Initial load
  load().catch(e => {
    if($("status")) $("status").innerHTML = `<span class="bad">Fehler: ${esc(e.message)}</span>`;
  });
</script>

</body>
</html>
