<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Zeiterfassung – Terminal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { background:#111; color:#fff; font-family:Arial; text-align:center; padding:22px; }
  .card { background:#222; padding:18px; border-radius:10px; max-width:360px; margin:0 auto 14px; }
  input, select, button { width:100%; padding:12px; margin:8px 0; font-size:1.05em; }
  button { cursor:pointer; }
  .ok { color:#0f0; font-size:1.15em; white-space:pre-line; }
  .err { color:#f66; white-space:pre-line; }
</style>
</head>
<body>

<div class="card" id="loginCard">
  <h2>Mitarbeiter Anmeldung</h2>
  <input id="empId" placeholder="Mitarbeiter-ID">
  <button onclick="login()">Anmelden</button>
  <div class="err" id="loginErr"></div>
</div>

<div class="card" id="projectCard" style="display:none">
  <h2 id="welcome"></h2>
  <select id="projectSelect"></select>
  <input id="manualProject" placeholder="Ausnahme Projekt-ID">
  <button onclick="useManual()">Ausnahme verwenden</button>
  <button onclick="confirmProject()">Weiter</button>
  <div class="err" id="projErr"></div>
</div>

<div class="card" id="actionCard" style="display:none">
  <div class="ok" id="headerText"></div>
  <button onclick="sendEvent('IN')">Arbeitsbeginn</button>
  <button onclick="sendEvent('PAUSE')">Pause</button>
  <button onclick="sendEvent('OUT')">Arbeitsende</button>
  <div class="err" id="eventErr"></div>
</div>

<script>
let employee=null, projectId=null;

function todayIso(){ return new Date().toISOString().slice(0,10); }

async function login(){
  loginErr.innerText="";
  const id=empId.value.trim();
  if(!id) return;
  const r=await fetch(`/api/terminal/login?employee_id=${id}`);
  const d=await r.json();
  if(!d.ok){ loginErr.innerText="Mitarbeiter nicht gefunden"; return; }
  employee=d.employee;
  loadProjects();
}

async function loadProjects(){
  const r=await fetch(`/api/allowed-projects?employee_id=${employee.employee_id}&date=${todayIso()}`);
  const d=await r.json();
  projectSelect.innerHTML="";
  if(d.projects.length){
    d.projects.forEach(p=>{
      const o=document.createElement("option");
      o.value=p.project_id;
      o.text=`${p.project_id} – ${p.name}`;
      projectSelect.appendChild(o);
    });
  }else{
    const o=document.createElement("option");
    o.value="";
    o.text="Kein Projekt zugewiesen";
    projectSelect.appendChild(o);
  }
  welcome.innerText=`Hallo ${employee.name}`;
  loginCard.style.display="none";
  projectCard.style.display="block";
}

function useManual(){
  const v=manualProject.value.trim();
  if(!v){ projErr.innerText="Projekt-ID fehlt"; return; }
  projectId=v;
  showActions("(Ausnahme)");
}

function confirmProject(){
  const v=projectSelect.value;
  if(!v){ projErr.innerText="Kein Projekt ausgewählt"; return; }
  projectId=v;
  showActions("");
}

function showActions(extra){
  projectCard.style.display="none";
  actionCard.style.display="block";
  headerText.innerText=`${employee.name}\nProjekt: ${projectId} ${extra}`;
}

async function sendEvent(type){
  eventErr.innerText="";
  if(!projectId){ eventErr.innerText="Kein Projekt"; return; }
  const r=await fetch("/api/time-event",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      employee_id:employee.employee_id,
      project_id:projectId,
      event_type:type,
      date:todayIso()
    })
  });
  const d=await r.json();
  if(!d.ok){ eventErr.innerText="Zeitbuchung fehlgeschlagen"; return; }
  actionCard.innerHTML=`<div class="ok">Gespeichert${d.is_exception?" (AUSNAHME)":""}</div>`;
  setTimeout(()=>location.reload(),4000);
}
</script>

</body>
</html>
