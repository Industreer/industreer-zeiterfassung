<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin – Mitarbeiter + Abwesenheiten</title>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:1300px}
    h1{margin:0 0 10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:10px 12px;font-size:14px}
    input[type="text"], input[type="date"]{min-width:220px}
    button{cursor:pointer}
    .card{border:1px solid #ddd;border-radius:10px;padding:16px;margin:14px 0}
    .muted{color:#666}
    .ok{color:#0a7b2e}
    .bad{color:#b10000}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .small{font-size:12px}
    img.logo-preview{max-height:80px;border:1px solid #ddd;padding:6px;border-radius:6px;background:#fff}

    table{border-collapse:collapse;width:100%;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;vertical-align:top}
    th{background:#fafafa;position:sticky;top:0;z-index:1}
    .tag{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid #ddd}
    .tag.auto{border-color:#f0b4b4;background:#fff5f5}
    .tag.manual{border-color:#b4d6f0;background:#f5fbff}

    .btn{border:1px solid #ddd;border-radius:8px;background:#fff}
    .btn.primary{border-color:#b4d6f0;background:#f5fbff}
    .btn.danger{border-color:#f0b4b4;background:#fff5f5}

    /* Status colors */
    tr.sick{background:#fff1f1}
    tr.sick td{border-bottom-color:#f3c3c3}

    .pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #ddd;
      background:#fff;
      white-space:nowrap;
    }
    .pill.sick{border-color:#f0b4b4;background:#fff5f5}
    .pill.vac{border-color:#ffe1a6;background:#fff9e6}

    /* Absences panel */
    #absCard{display:none}
    #absList td{vertical-align:middle}
  </style>
</head>

<body>

<h1>Admin – Mitarbeiter + Abwesenheiten</h1>
<div class="muted">
  Ziel: Mitarbeiter verwalten + Abwesenheiten (Krank/Urlaub von/bis).
</div>
<div class="card" style="margin-top:12px">
  <div class="row">
    <a href="/reports.html" class="btn primary" style="text-decoration:none;display:inline-block;">
      Reports (Clamp)
    </a>
    <a href="/staffplan.html" class="btn" style="text-decoration:none;display:inline-block;">
      Staffplan
    </a>
    <a href="/terminal.html" class="btn" style="text-decoration:none;display:inline-block;">
      Terminal
    </a>
  </div>
  <div class="muted small" style="margin-top:8px">
    Reports zeigt Clamp-Preview + Detail- und Summary-Reports.
  </div>
</div>

<!-- ====================================================== -->
<!-- LOGO UPLOAD -->
<!-- ====================================================== -->
<div class="card">
  <h3 style="margin:0 0 8px">Firmenlogo</h3>

  <div class="muted small" style="margin-bottom:10px">
    Das Logo wird z.B. für PDFs / Reports verwendet.
    Empfohlen: <b>PNG mit transparentem Hintergrund</b>.
  </div>

  <div class="row">
    <input id="logoFile" type="file" accept="image/png"/>
    <button id="btnUploadLogo" class="btn primary">Logo hochladen</button>
    <span id="logoOut" class="small muted"></span>
  </div>

  <div style="margin-top:12px">
    <div class="muted small">Aktuelles Logo:</div>
    <img id="logoPreview" class="logo-preview" src="/api/logo" alt="Kein Logo vorhanden">
  </div>
</div>

<!-- ====================================================== -->
<!-- CONTROLS -->
<!-- ====================================================== -->
<div class="card">
  <div class="row">
    <button id="btnReload" class="btn primary">Neu laden</button>

    <label class="muted">Suche:</label>
    <input id="q" type="text" placeholder="Name oder ID (z.B. Damir, AUTO_, 0815)"/>

    <label class="muted">Filter:</label>
    <select id="filter">
      <option value="all">Alle</option>
      <option value="auto">Nur AUTO_* (id_source=auto)</option>
      <option value="manual">Nur manuell</option>
      <option value="used">Mit Daten (staffplan/time/breaks > 0)</option>
      <option value="sick">Heute krank (rot)</option>
    </select>

    <span id="statusTop" class="muted"></span>
  </div>
</div>

<!-- ====================================================== -->
<!-- AUTO_* UMHÄNGEN -->
<!-- ====================================================== -->
<div class="card">
  <h3 style="margin:0 0 8px">AUTO_* umhängen</h3>
  <div class="muted small" style="margin-bottom:10px">
    Vorgehen: <b>alte AUTO_…</b> auswählen → <b>neue echte ID</b> eingeben → „Umhängen“.
  </div>

  <div class="row">
    <label>Alte ID (AUTO_*):</label>
    <select id="oldId"></select>

    <label>Neue ID:</label>
    <input id="newId" type="text" placeholder="z.B. 0815"/>

    <label class="muted">Merge-Modus:</label>
    <select id="merge">
      <option value="keep_new">keep_new (bestehende neue Daten behalten)</option>
      <option value="keep_old">keep_old (Name/Email/Sprache von alt übernehmen)</option>
    </select>

    <button id="btnMove" class="btn primary">Umhängen</button>
  </div>

  <div id="moveResult" class="small" style="margin-top:10px"></div>
</div>
<!-- ====================================================== -->
<!-- EMPLOYEES IMPORT (Excel) -->
<!-- ====================================================== -->
<div class="card">
  <h3 style="margin:0 0 8px">Mitarbeiter-IDs importieren (Excel)</h3>
  <div class="muted small" style="margin-bottom:10px">
    Erwartet eine Excel mit Spalten <span class="mono">employee_id</span> und <span class="mono">name</span>.
    Namen dürfen als <span class="mono">Nachname, Vorname</span> kommen (wird normalisiert).
  </div>

  <div class="row">
    <input id="empImportFile" type="file" accept=".xlsx"/>
    <button id="btnEmpImport" class="btn primary">Excel importieren</button>
    <span id="empImportOut" class="small muted"></span>
  </div>

  <div id="empImportResult" class="small" style="margin-top:10px"></div>
</div>

<!-- ====================================================== -->
<!-- RESET -->
<!-- ====================================================== -->
<div class="card">
  <h3 style="margin:0 0 8px">Tools: Import-Daten zurücksetzen</h3>
  <div class="muted small" style="margin-bottom:10px">
    Vorsicht: löscht serverseitig Importdaten (nur nutzen, wenn du es wirklich willst).
  </div>
  <div class="row">
    <label class="muted">Bestätigung:</label>
    <input id="resetConfirm" type="text" placeholder='RESET-ALL-IMPORT-DATA'/>
    <button id="btnResetImport" class="btn danger">Reset ausführen</button>
    <span id="resetOut" class="small muted"></span>
  </div>
</div>

<!-- ====================================================== -->
<!-- ABSENCES PANEL -->
<!-- ====================================================== -->
<div id="absCard" class="card">
  <div class="row" style="justify-content:space-between">
    <div>
      <h3 id="absHeader" style="margin:0 0 8px">Abwesenheiten</h3>
      <div class="muted small">Abwesenheiten sind <b>von/bis inklusive</b>.</div>
    </div>
    <div class="row">
      <button id="btnAbsClose" class="btn">Schließen</button>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <label class="muted">Typ:</label>
    <select id="absType">
      <option value="sick">Krank</option>
      <option value="vacation">Urlaub</option>
    </select>

    <label class="muted">von:</label>
    <input id="absFrom" type="date"/>

    <label class="muted">bis:</label>
    <input id="absTo" type="date"/>

    <label class="muted">Notiz:</label>
    <input id="absNote" type="text" placeholder="optional"/>

    <button id="btnAbsCreate" class="btn primary">Speichern</button>

    <span id="absOut" class="small muted"></span>
  </div>

  <div style="margin-top:14px">
    <div class="muted small">Aktive Abwesenheiten:</div>
    <table style="margin-top:8px">
      <thead>
        <tr>
          <th>Typ</th>
          <th>von</th>
          <th>bis</th>
          <th>Notiz</th>
          <th>Status</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody id="absList"></tbody>
    </table>
  </div>
</div>

<!-- ====================================================== -->
<!-- MITARBEITERÜBERSICHT -->
<!-- ====================================================== -->
<div class="card">
  <h3 style="margin:0 0 8px">Mitarbeiterübersicht</h3>
  <div class="muted small">
    Email & Sprache sind editierbar. Änderungen werden automatisch gespeichert.
    <span class="mono">Rot</span> = heute krank.
  </div>

  <table>
    <thead>
      <tr>
        <th>Status</th>
        <th>ID</th>
        <th>Name</th>
        <th>Email</th>
        <th>Sprache</th>
<th>Wochenstunden</th>
        <th>Quelle</th>
        <th>Staffplan</th>
        <th>Zeiten</th>
        <th>Pausen</th>
        <th>Abwesenheiten</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div id="statusBottom" class="muted small" style="margin-top:10px"></div>
</div>

<script>
  const $ = (id)=>document.getElementById(id);
  let allRows = [];

  // Absences state
  let absEmployeeId = null;
  let absEmployeeName = null;

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Berlin today ISO YYYY-MM-DD (for date inputs and comparisons)
  function todayIso(){
    const fmt = new Intl.DateTimeFormat("en-CA", {
      timeZone: "Europe/Berlin",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
    });
    return fmt.format(new Date());
  }

  // Admin code header for /api/admin/*
async function api(url, options = {}){
  const opts = { ...options };

  // Headers sauber zusammenbauen
  const headers = new Headers(opts.headers || {});

  // Admin-Code immer mitschicken (für /api/admin/*)
  headers.set("x-admin-code", "2012");

  // Content-Type NUR setzen, wenn wir JSON senden (nicht bei FormData!)
  const isFormData = (opts.body instanceof FormData);
  const isJsonBody = opts.body && !isFormData && typeof opts.body === "string";

  if (isJsonBody && !headers.has("Content-Type")) {
    headers.set("Content-Type", "application/json");
  }

  opts.headers = headers;

  const r = await fetch(url, opts);
  const t = await r.text();

  let j;
  try { j = JSON.parse(t); } catch { j = { ok: r.ok, raw: t }; }

  if(!r.ok || j.ok === false) {
    const msg = j.error || j.message || t || ("HTTP " + r.status);
    throw new Error(msg);
  }
  return j;
}


  // EU-Sprachen + Türkisch
  const LANGS = [
    ["de","Deutsch"],["en","English"],["fr","Français"],["it","Italiano"],["es","Español"],["pt","Português"],
    ["nl","Nederlands"],["da","Dansk"],["sv","Svenska"],["no","Norsk"],["fi","Suomi"],["is","Íslenska"],
    ["ga","Gaeilge"],["mt","Malti"],["lb","Lëtzebuergesch"],["et","Eesti"],["lv","Latviešu"],["lt","Lietuvių"],
    ["pl","Polski"],["cs","Čeština"],["sk","Slovenčina"],["hu","Magyar"],["sl","Slovenščina"],["hr","Hrvatski"],
    ["ro","Română"],["bg","Български"],["el","Ελληνικά"],["tr","Türkçe"],
  ];

  function normalizeLang(v){
    const s = String(v || "de").trim().toLowerCase();
    return s.includes("-") ? s.split("-")[0] : s;
  }

  function renderLanguageSelect(employee_id, current){
    const normalized = normalizeLang(current);
    return `
      <select data-field="language" data-employee-id="${esc(employee_id)}">
        ${LANGS.map(([code,label]) => `
          <option value="${esc(code)}" ${code===normalized ? "selected" : ""}>${esc(label)}</option>
        `).join("")}
      </select>
    `;
  }

  function renderEmailInput(employee_id, current){
    return `
      <input
        type="text"
        style="min-width:240px"
        data-field="email"
        data-employee-id="${esc(employee_id)}"
        value="${esc(current || "")}"
        placeholder="name@firma.de"
      />
    `;
  }
function renderWeeklyHoursInput(employee_id, current){
  const v = (current === null || current === undefined) ? "" : String(current);
  return `
    <input
      type="number"
      step="0.25"
      min="0"
      style="width:110px"
      data-field="weekly_hours"
      data-employee-id="${esc(employee_id)}"
      value="${esc(v)}"
      placeholder="40"
      title="Vertragliche Wochenstunden (z.B. 40 oder 37.5)"
    />
  `;
}
  function statusPill(status){
    if(status === "sick") return `<span class="pill sick">Krank (heute)</span>`;
    if(status === "vacation") return `<span class="pill vac">Urlaub (heute)</span>`;
    return `<span class="muted small">–</span>`;
  }

  function renderTable(rows){
    const q = ($("q")?.value || "").trim().toLowerCase();
    const filter = $("filter")?.value || "all";

    let out = rows || [];

    if(q){
      out = out.filter(r =>
        String(r.employee_id).toLowerCase().includes(q) ||
        String(r.name||"").toLowerCase().includes(q) ||
        String(r.email||"").toLowerCase().includes(q)
      );
    }

    if(filter === "auto") out = out.filter(r => r.id_source === "auto");
    if(filter === "manual") out = out.filter(r => r.id_source !== "auto");
    if(filter === "used") out = out.filter(r => (r.staffplan_rows+r.time_rows+r.break_rows) > 0);
    if(filter === "sick") out = out.filter(r => r.__todayStatus === "sick");

    const tb = $("tbody");
    if(!tb) return;

    tb.innerHTML = out.map(r => `
      <tr class="${r.__todayStatus === 'sick' ? 'sick' : ''}">
        <td>${statusPill(r.__todayStatus)}</td>
        <td class="mono">${esc(r.employee_id)}</td>
        <td>${esc(r.name)}</td>
        <td>${renderEmailInput(r.employee_id, r.email)}</td>
        <td>${renderLanguageSelect(r.employee_id, r.language)}</td>
        <td>${renderWeeklyHoursInput(r.employee_id, r.weekly_hours)}</td>        
        <td>
          <span class="tag ${r.id_source === 'auto' ? 'auto':'manual'}">
            ${r.id_source === 'auto' ? 'AUTO' : 'manuell'}
          </span>
        </td>
        <td>${esc(r.staffplan_rows)}</td>
        <td>${esc(r.time_rows)}</td>
        <td>${esc(r.break_rows)}</td>
        <td>
          <button
            class="btn"
            data-action="absences"
            data-employee-id="${esc(r.employee_id)}"
            data-employee-name="${esc(r.name)}"
          >Verwalten</button>
        </td>
      </tr>
    `).join("");

    const top = $("statusTop");
    const bottom = $("statusBottom");
    const txt = `Zeilen: ${out.length} (gesamt: ${(rows||[]).length})`;
    if(top) top.textContent = txt;
    if(bottom) bottom.textContent = txt;
  }

  function fillAutoDropdown(rows){
    const autos = (rows || [])
      .filter(r => r.id_source === "auto")
      .sort((a,b)=> (b.staffplan_rows+b.time_rows+b.break_rows) - (a.staffplan_rows+a.time_rows+a.break_rows));

    const sel = $("oldId");
    if(!sel) return;

    sel.innerHTML = autos.map(r => {
      const used = r.staffplan_rows+r.time_rows+r.break_rows;
      const label = `${r.employee_id} — ${r.name} (Daten: ${used})`;
      return `<option value="${esc(r.employee_id)}">${esc(label)}</option>`;
    }).join("");

    if(!autos.length){
      sel.innerHTML = `<option value="">Keine AUTO_* Einträge gefunden</option>`;
    }
  }

  // ================= Absences UI =================
  function setAbsOutput(msg, ok){
    const out = $("absOut");
    if(!out) return;
    out.className = "small " + (ok === true ? "ok" : ok === false ? "bad" : "muted");
    out.textContent = msg || "";
  }

  function renderAbsList(rows){
    const tb = $("absList");
    if(!tb) return;

    if(!rows.length){
      tb.innerHTML = `<tr><td colspan="6" class="muted small">Keine aktiven Abwesenheiten.</td></tr>`;
      return;
    }

    tb.innerHTML = rows.map(r => `
      <tr>
        <td>${r.type === "sick" ? `<span class="pill sick">Krank</span>` : `<span class="pill vac">Urlaub</span>`}</td>
        <td class="mono">${esc(r.date_from)}</td>
        <td class="mono">${esc(r.date_to)}</td>
        <td>${esc(r.note || "")}</td>
        <td>${esc(r.status)}</td>
        <td class="row" style="gap:8px">
          <button class="btn" data-action="abs-cancel" data-id="${esc(r.id)}">Cancel</button>
          <button class="btn danger" data-action="abs-del" data-id="${esc(r.id)}">Delete</button>
        </td>
      </tr>
    `).join("");
  }

  async function openAbsences(employee_id, employee_name){
    absEmployeeId = employee_id;
    absEmployeeName = employee_name;

    const card = $("absCard");
    const header = $("absHeader");
    if(card) card.style.display = "block";
    if(header) header.innerHTML = `Abwesenheiten – <b>${esc(employee_name)}</b> <span class="mono">${esc(employee_id)}</span>`;

    const t = todayIso();
    if($("absFrom")) $("absFrom").value = t;
    if($("absTo")) $("absTo").value = t;
    if($("absNote")) $("absNote").value = "";
    if($("absType")) $("absType").value = "sick";

    await refreshAbsences();
    setAbsOutput("", null);
  }

  function closeAbsences(){
    const card = $("absCard");
    if(card) card.style.display = "none";
    absEmployeeId = null;
    absEmployeeName = null;
  }

  async function refreshAbsences(){
    if(!absEmployeeId) return;
    setAbsOutput("Lade…", null);
    const j = await api(`/api/admin/absences?employee_id=${encodeURIComponent(absEmployeeId)}&status=active`);
    renderAbsList(j.rows || []);
    setAbsOutput("", null);
  }

  async function createAbsence(){
    if(!absEmployeeId) return;

    const type = $("absType")?.value || "sick";
    const date_from = $("absFrom")?.value || "";
    const date_to = $("absTo")?.value || "";
    const note = ($("absNote")?.value || "").trim();

    if(!date_from || !date_to){
      setAbsOutput("Bitte von/bis setzen.", false);
      return;
    }
    if(date_to < date_from){
      setAbsOutput("bis darf nicht vor von liegen.", false);
      return;
    }

    try{
      setAbsOutput("Speichern…", null);
      await api("/api/admin/absences", {
        method: "POST",
        body: JSON.stringify({ employee_id: absEmployeeId, type, date_from, date_to, note })
      });

      setAbsOutput("✅ Gespeichert", true);
      await refreshAbsences();

      // reload employees so sick-status updates
      await load();
    }catch(e){
      setAbsOutput("❌ " + e.message, false);
    }
  }

  async function cancelAbsence(id){
    try{
      setAbsOutput("Cancel…", null);
      await api(`/api/admin/absences/${encodeURIComponent(id)}`, {
        method: "PATCH",
        body: JSON.stringify({ status: "cancelled" })
      });
      await refreshAbsences();
      await load();
      setAbsOutput("✅ Abwesenheit gecancelt", true);
    }catch(e){
      setAbsOutput("❌ " + e.message, false);
    }
  }

  async function deleteAbsence(id){
    if(!confirm("Wirklich löschen?")) return;
    try{
      setAbsOutput("Löschen…", null);
      await api(`/api/admin/absences/${encodeURIComponent(id)}`, { method: "DELETE" });
      await refreshAbsences();
      await load();
      setAbsOutput("✅ Gelöscht", true);
    }catch(e){
      setAbsOutput("❌ " + e.message, false);
    }
  }

  // ================= Today Status (red logic) =================
  function isoInRange(iso, fromIso, toIso){
    // all YYYY-MM-DD lexicographic comparable
    return iso >= fromIso && iso <= toIso;
  }

  async function fetchTodayStatusForEmployee(employee_id){
    // Determine if today is within any ACTIVE absence for employee
    // Priority: sick > vacation
    const j = await api(`/api/admin/absences?employee_id=${encodeURIComponent(employee_id)}&status=active`);
    const rows = j.rows || [];
    const t = todayIso();

    let hasVacation = false;
    for(const a of rows){
      const fromIso = String(a.date_from || "");
      const toIso = String(a.date_to || "");
      if(!fromIso || !toIso) continue;
      if(!isoInRange(t, fromIso, toIso)) continue;

      if(a.type === "sick") return "sick";
      if(a.type === "vacation") hasVacation = true;
    }
    return hasVacation ? "vacation" : null;
  }

  async function enrichRowsWithTodayStatus(rows){
    // Concurrency limit so we don't spam the server
    const limit = 8;
    let idx = 0;

    const workers = new Array(limit).fill(0).map(async () => {
      while(idx < rows.length){
        const i = idx++;
        const r = rows[i];
        try{
          r.__todayStatus = await fetchTodayStatusForEmployee(r.employee_id);
        }catch{
          r.__todayStatus = null;
        }
      }
    });

    await Promise.all(workers);
    return rows;
  }

  // ================= Load =================
  async function load(){
    const st = $("statusTop");
    if(st) st.textContent = "Lade…";

    const j = await api("/api/admin/employees");
    allRows = j.rows || [];

    // add today status (sick/vacation)
    await enrichRowsWithTodayStatus(allRows);

    renderTable(allRows);
    fillAutoDropdown(allRows);
  }

  // ---------------- AUTO SAVE (Email + Sprache) ----------------
  async function saveField(el){
    const employee_id = el.dataset.employeeId;
    const field = el.dataset.field;
    if(!employee_id || !field) return;

    const payload = { employee_id };
    if(field === "language"){
  payload[field] = el.value;
} else if(field === "weekly_hours"){
  const v = String(el.value || "").trim();
  payload[field] = v === "" ? null : Number(v);
} else {
  payload[field] = el.value.trim();
}

    const prevOutline = el.style.outline;
    el.disabled = true;

    try{
      await api("/api/admin/employees", {
        method: "PATCH",
        body: JSON.stringify(payload)
      });

      el.style.outline = "2px solid #0a7b2e";
      setTimeout(()=> el.style.outline = prevOutline, 700);

      await load();
    }catch(err){
      el.style.outline = "2px solid #b10000";
      setTimeout(()=> el.style.outline = prevOutline, 1200);
      alert("❌ Konnte nicht speichern: " + err.message);
    }finally{
      el.disabled = false;
    }
  }

  document.addEventListener("change", (e) => {
    const el = e.target;
    if(!el || !el.matches("select[data-field='language'][data-employee-id]")) return;
    saveField(el);
  });

  document.addEventListener("blur", (e) => {
    const el = e.target;
    if(!el || !el.matches("input[data-field='email'][data-employee-id], input[data-field='weekly_hours'][data-employee-id]")) return;
    saveField(el);
  }, true);

  // ---------------- LOGO ----------------
  async function uploadLogo(){
    const fileEl = $("logoFile");
    const out = $("logoOut");
    const img = $("logoPreview");

    if(!fileEl?.files || !fileEl.files[0]){
      out.className = "small bad";
      out.textContent = "❌ Bitte eine PNG-Datei auswählen.";
      return;
    }

    const f = fileEl.files[0];
    if(!f.name.toLowerCase().endsWith(".png")){
      out.className = "small bad";
      out.textContent = "❌ Nur PNG-Dateien erlaubt.";
      return;
    }

    out.className = "small muted";
    out.textContent = "⬆️ Upload läuft…";

    try{
      const fd = new FormData();
      fd.append("file", f);

      const r = await fetch("/api/logo", {
  method: "POST",
  headers: { "x-admin-code": "2012" }, // schadet nicht, hilft falls du später absicherst
  body: fd
});
      const t = await r.text();
      let j; try { j = JSON.parse(t); } catch { j = { ok:false, raw:t }; }

      if(!r.ok || j.ok === false){
        throw new Error(j.error || j.message || t);
      }

      out.className = "small ok";
      out.textContent = "✅ Logo erfolgreich gespeichert";

      if(img){
        img.style.display = "inline-block";
        img.src = "/api/logo?ts=" + Date.now();
      }
      fileEl.value = "";
    }catch(e){
      out.className = "small bad";
      out.textContent = "❌ " + e.message;
    }
  }

  const logoImg = $("logoPreview");
  if(logoImg){
    logoImg.addEventListener("error", ()=> { logoImg.style.display = "none"; });
    logoImg.addEventListener("load", ()=> { logoImg.style.display = "inline-block"; });
  }

  // ---------------- MOVE AUTO ID ----------------
  async function move(){
    const old_employee_id = $("oldId")?.value || "";
    const new_employee_id = ($("newId")?.value || "").trim();
    const merge = $("merge")?.value || "keep_new";
    const out = $("moveResult");

    if(!old_employee_id){
      if(out) out.innerHTML = `<span class="bad">Bitte eine alte AUTO_* ID wählen.</span>`;
      return;
    }
    if(!new_employee_id){
      if(out) out.innerHTML = `<span class="bad">Bitte neue ID eingeben (z.B. 0815).</span>`;
      return;
    }
    if(new_employee_id.startsWith("AUTO_")){
      if(out) out.innerHTML = `<span class="bad">Neue ID darf nicht mit AUTO_ beginnen.</span>`;
      return;
    }

    if(out) out.innerHTML = `<span class="muted">Umhängen läuft…</span>`;

    try{
      const j = await api("/api/admin/employee-id", {
        method:"POST",
        body: JSON.stringify({ old_employee_id, new_employee_id, merge })
      });

      if(out){
        out.innerHTML = `
          <div class="ok"><b>✅ Erfolgreich umgehängt</b></div>
          <div class="small">
            <div>Alt: <span class="mono">${esc(j.old_employee_id)}</span> → Neu: <span class="mono">${esc(j.new_employee_id)}</span></div>
            <div>Aktualisiert: staffplan=${esc(j.updated?.staffplan)}, time_entries=${esc(j.updated?.time_entries)}, breaks=${esc(j.updated?.breaks)}</div>
            <div class="muted">Merge-Modus: ${esc(j.merge_mode)}</div>
          </div>
        `;
      }

      await load();
      const newEl = $("newId"); if(newEl) newEl.value = "";
    }catch(e){
      if(out) out.innerHTML = `<span class="bad">❌ Fehler: ${esc(e.message)}</span>`;
    }
  }

  // ---------------- RESET ----------------
  async function doReset(){
    const out = $("resetOut");
    if(out){
      out.className = "small muted";
      out.textContent = "Reset läuft…";
    }

    try {
      const confirm = ($("resetConfirm")?.value || "").trim();
      const j = await api("/api/admin/reset", {
        method: "POST",
        body: JSON.stringify({ confirm })
      });

      if(out){
        out.className = "small ok";
        out.textContent = "✅ " + (j.note || "Reset erfolgreich");
      }

      await load();
      const c = $("resetConfirm"); if(c) c.value = "";
    } catch (e) {
      if(out){
        out.className = "small bad";
        out.textContent = "❌ " + e.message;
      }
    }
  }
async function importEmployeesExcel(){
  const fileEl = $("empImportFile");
  const out = $("empImportOut");
  const box = $("empImportResult");

  if(out){ out.className = "small muted"; out.textContent = ""; }
  if(box) box.innerHTML = "";

  if(!fileEl?.files || !fileEl.files[0]){
    if(out){ out.className = "small bad"; out.textContent = "❌ Bitte eine .xlsx Datei auswählen."; }
    return;
  }

  const f = fileEl.files[0];
  if(!f.name.toLowerCase().endsWith(".xlsx")){
    if(out){ out.className = "small bad"; out.textContent = "❌ Nur .xlsx erlaubt."; }
    return;
  }

  try{
    if(out){ out.className = "small muted"; out.textContent = "Upload läuft…"; }

    const fd = new FormData();
    fd.append("file", f);

    // Wichtig: NICHT api() verwenden, weil api() Content-Type sonst falsch setzt.
    // Wir nutzen fetch direkt, aber mit Admin-Header.
    const r = await fetch("/api/admin/import/employees", {
      method: "POST",
      headers: { "x-admin-code": "2012" },
      body: fd
    });

    const t = await r.text();
    let j; try { j = JSON.parse(t); } catch { j = { ok:false, raw:t }; }

    if(!r.ok || j.ok === false){
      throw new Error(j.error || j.message || t);
    }

    if(out){ out.className = "small ok"; out.textContent = "✅ Import fertig"; }

    if(box){
      box.innerHTML = `
        <div class="ok"><b>✅ Mitarbeiter importiert</b></div>
        <div class="small">
          <div>Datei: <span class="mono">${esc(j.file || f.name)}</span></div>
          <div>Zeilen in Datei: <b>${esc(j.rows_in_file)}</b></div>
          <div>Inserted: <b>${esc(j.inserted)}</b>, Updated: <b>${esc(j.updated)}</b>, Skipped: <b>${esc(j.skipped)}</b></div>
          <div class="muted">${esc(j.note || "")}</div>
        </div>
      `;
    }

    // optional: reload employees list so you see manual IDs immediately
    await load();

    fileEl.value = "";
  }catch(e){
    if(out){ out.className = "small bad"; out.textContent = "❌ " + e.message; }
  }
}

  // ---------------- EVENTS ----------------
  $("btnUploadLogo")?.addEventListener("click", uploadLogo);
  $("btnReload")?.addEventListener("click", load);
  $("btnEmpImport")?.addEventListener("click", importEmployeesExcel);

  $("btnMove")?.addEventListener("click", move);
  $("btnResetImport")?.addEventListener("click", doReset);

  $("btnAbsCreate")?.addEventListener("click", createAbsence);
  $("btnAbsClose")?.addEventListener("click", closeAbsences);

  $("q")?.addEventListener("input", ()=>renderTable(allRows));
  $("filter")?.addEventListener("change", ()=>renderTable(allRows));

  document.addEventListener("click", (e) => {
    const el = e.target;
    if(!el) return;

    if(el.matches("button[data-action='absences'][data-employee-id]")){
      openAbsences(el.dataset.employeeId, el.dataset.employeeName || el.dataset.employeeId)
        .catch(err => alert("❌ " + err.message));
      return;
    }

    if(el.matches("button[data-action='abs-cancel'][data-id]")){
      cancelAbsence(el.dataset.id);
      return;
    }

    if(el.matches("button[data-action='abs-del'][data-id]")){
      deleteAbsence(el.dataset.id);
      return;
    }
  });

  // Init
  load().catch(e=>{
    const top = $("statusTop");
    if(top) top.innerHTML = `<span class="bad">Fehler: ${esc(e.message)}</span>`;
  });
</script>

</body>
</html>
