<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Reports – Arbeitszeiten</title>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:1200px}
    h1{margin:0 0 10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,button,label{font-size:14px}
    input,button{padding:10px 12px}
    button{cursor:pointer}
    .card{border:1px solid #ddd;border-radius:10px;padding:16px;margin:14px 0}
    table{border-collapse:collapse;width:100%;margin-top:12px}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left}
    th{background:#fafafa}
    .muted{color:#666}
    .bad{color:#b10000}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .btn{border:1px solid #ddd;border-radius:8px;background:#fff}
    .btn.primary{border-color:#b4d6f0;background:#f5fbff}
  </style>
</head>

<body>

<h1>Reports – Arbeitszeiten</h1>
<div class="muted">
  Summary-Report (Clamp-Logik berücksichtigt).
</div>

<div class="card">
  <div class="row" style="gap:10px">
       <button id="btnSummaryCsv" class="btn">Summary CSV</button>

    <button id="btnDaily" class="btn">Daily laden</button>

    <button id="btnDailyCsv" class="btn">Daily CSV</button>

    <button id="btnOpen" class="btn">Offene Zeiten</button>

 
<div class="card">
  <table>
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
  const $ = (id)=>document.getElementById(id);

  function todayIso(){ return new Date().toISOString().slice(0,10); }

  // Default: heute
  $("from").value = $("from").value || todayIso();
  $("to").value = $("to").value || todayIso();

  function setStatus(msg){ $("status").textContent = msg || ""; }
  function setError(msg){ $("error").textContent = msg || ""; }

  async function api(url){
    const code = ($("code").value || "").trim();
    const r = await fetch(url, { headers: { "x-admin-code": code } });
    const t = await r.text();
    let j;
    try { j = JSON.parse(t); } catch { j = { ok:false, error:t }; }
    if(!r.ok || j.ok === false) throw new Error(j.error || ("HTTP " + r.status));
    return j;
  }

  function num(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function render(rows, mode){
    const tb = $("tbody");
    const th = $("thead");

    // mode: "summary" | "daily" | "open"
    if(mode === "summary"){
      const include_po = $("byPo").checked;

      th.innerHTML = `
        <tr>
          <th>Mitarbeiter</th>
          ${include_po ? `<th class="mono">Customer PO</th><th class="mono">Interne PO</th>` : ``}
          <th>Tage</th>
          <th>Stunden</th>
        </tr>
      `;

      if(!rows || !rows.length){
        tb.innerHTML = `<tr><td colspan="${include_po ? 5 : 3}" class="muted">Keine Daten.</td></tr>`;
        return;
      }

      tb.innerHTML = rows.map(r => `
        <tr>
          <td class="mono">${r.employee_id}</td>
          ${include_po ? `<td class="mono">${r.mapped_customer_po || ""}</td><td class="mono">${r.mapped_internal_po || ""}</td>` : ``}
          <td>${r.days ?? ""}</td>
          <td>${num(r.hours).toFixed(2)}</td>
        </tr>
      `).join("");
      return;
    }

    if(mode === "daily"){
      th.innerHTML = `
        <tr>
          <th>Datum</th>
          <th>Mitarbeiter</th>
          <th class="mono">Customer PO</th>
          <th class="mono">Interne PO</th>
          <th>Start</th>
          <th>Ende</th>
          <th>Pause (min)</th>
          <th>Stunden</th>
        </tr>
      `;

      if(!rows || !rows.length){
        tb.innerHTML = `<tr><td colspan="8" class="muted">Keine Daten.</td></tr>`;
        return;
      }

      tb.innerHTML = rows.map(r => `
        <tr>
          <td class="mono">${String(r.work_date || "").slice(0,10)}</td>
          <td class="mono">${r.employee_id}</td>
          <td class="mono">${r.mapped_customer_po || ""}</td>
          <td class="mono">${r.mapped_internal_po || ""}</td>
          <td class="mono">${r.start_ts ? String(r.start_ts).replace("T"," ").slice(0,19) : ""}</td>
          <td class="mono">${r.end_ts ? String(r.end_ts).replace("T"," ").slice(0,19) : ""}</td>
          <td>${r.break_minutes ?? 0}</td>
          <td>${num(r.hours).toFixed(2)}</td>
        </tr>
      `).join("");
      return;
    }

    if(mode === "open"){
      th.innerHTML = `
        <tr>
          <th>Datum</th>
          <th>Mitarbeiter</th>
          <th class="mono">Customer PO</th>
          <th class="mono">Interne PO</th>
          <th>Start</th>
          <th>Pause (min)</th>
          <th>Status</th>
        </tr>
      `;

      if(!rows || !rows.length){
        tb.innerHTML = `<tr><td colspan="7" class="muted">Keine offenen Zeiten.</td></tr>`;
        return;
      }

      tb.innerHTML = rows.map(r => `
        <tr>
          <td class="mono">${String(r.work_date || "").slice(0,10)}</td>
          <td class="mono">${r.employee_id}</td>
          <td class="mono">${r.mapped_customer_po || ""}</td>
          <td class="mono">${r.mapped_internal_po || ""}</td>
          <td class="mono">${r.start_ts ? String(r.start_ts).replace("T"," ").slice(0,19) : ""}</td>
          <td>${r.break_minutes ?? 0}</td>
          <td class="bad"><b>OFFEN</b> (kein Clock-Out)</td>
        </tr>
      `).join("");
      return;
    }
  }

  function getRange(){
    const from = $("from").value;
    const to = $("to").value;
    if(!from || !to) throw new Error("Bitte Zeitraum wählen.");
    return { from, to };
  }

  async function loadSummary(){
    setError(""); setStatus("Lade Summary…");
    try{
      const {from,to} = getRange();
      const include_po = $("byPo").checked ? 1 : 0;
      const j = await api(`/api/admin/report-hours/summary?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&include_po=${include_po}`);
      render(j.rows || [], "summary");
      setStatus(`Summary: ${ (j.rows||[]).length } Zeilen`);
    }catch(e){
      setStatus("");
      setError("❌ " + e.message);
      render([], "summary");
    }
  }

  function downloadSummaryCsv(){
    try{
      const {from,to} = getRange();
      const code = ($("code").value || "").trim();
      const url = `/api/admin/report-hours/summary.csv?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&code=${encodeURIComponent(code)}`;
      window.location.href = url;
    }catch(e){
      setError("❌ " + e.message);
    }
  }

  async function loadDaily(){
    setError(""); setStatus("Lade Daily…");
    try{
      const {from,to} = getRange();
      const j = await api(`/api/admin/report-hours/daily?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);
      render(j.rows || [], "daily");
      setStatus(`Daily: ${ (j.rows||[]).length } Zeilen`);
    }catch(e){
      setStatus("");
      setError("❌ " + e.message);
      render([], "daily");
    }
  }

  function downloadDailyCsv(){
    try{
      const {from,to} = getRange();
      const code = ($("code").value || "").trim();
      const url = `/api/admin/report-hours/daily.csv?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&code=${encodeURIComponent(code)}`;
      window.location.href = url;
    }catch(e){
      setError("❌ " + e.message);
    }
  }

  async function loadOpen(){
    setError(""); setStatus("Lade offene Zeiten…");
    try{
      const {from,to} = getRange();
      const j = await api(`/api/admin/open-sessions?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);
      render(j.rows || [], "open");
      setStatus(`Offen: ${ (j.rows||[]).length } Zeilen`);
    }catch(e){
      setStatus("");
      setError("❌ " + e.message);
      render([], "open");
    }
  }

  $("btnLoad").addEventListener("click", loadSummary);
  $("btnSummaryCsv").addEventListener("click", downloadSummaryCsv);
  $("btnDaily").addEventListener("click", loadDaily);
  $("btnDailyCsv").addEventListener("click", downloadDailyCsv);
  $("btnOpen").addEventListener("click", loadOpen);

  // Default direkt Abrechnung laden
  loadSummary();
</script>

<script>
  const $ = (id)=>document.getElementById(id);

  function todayIso(){
    return new Date().toISOString().slice(0,10);
  }

  // Default: letzter Tag mit Daten ist bei dir oft in der Vergangenheit – daher heute als Start
  $("from").value = todayIso();
  $("to").value = todayIso();

  function setStatus(msg){ $("status").textContent = msg || ""; }
  function setError(msg){ $("error").textContent = msg || ""; }

  async function api(url){
    const code = ($("code").value || "").trim();
    const r = await fetch(url, { headers: { "x-admin-code": code } });
    const t = await r.text();
    let j;
    try { j = JSON.parse(t); } catch { j = { ok: false, error: t }; }
    if(!r.ok || j.ok === false) throw new Error(j.error || ("HTTP " + r.status));
    return j;
  }

  function renderTable(rows, include_po){
    const tb = $("tbody");
    const poCols = document.querySelectorAll(".poCol");
    poCols.forEach(c => c.style.display = include_po ? "" : "none");

    if(!rows || !rows.length){
      tb.innerHTML = `<tr><td colspan="${include_po ? 4 : 3}" class="muted">Keine Daten.</td></tr>`;
      return;
    }

    tb.innerHTML = rows.map(r => `
      <tr>
        <td class="mono">${r.employee_id}${r.employee_name ? ` — ${r.employee_name}` : ""}</td>
        ${include_po ? `<td class="mono">${r.mapped_customer_po || ""}</td>` : ""}
        <td>${r.entries}</td>
        <td>${Number(r.hours).toFixed(2)}</td>
      </tr>
    `).join("");
  }

  async function loadReport(){
    setError("");
    const from = $("from").value;
    const to = $("to").value;
    const include_po = $("byPo").checked;

    if(!from || !to){
      setError("Bitte Zeitraum wählen.");
      return;
    }

    setStatus("Lade…");

    try{
      const url =
        `/api/admin/report-hours/summary?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&include_po=${include_po ? 1 : 0}`;
      const j = await api(url);
      renderTable(j.rows || [], include_po);
      setStatus(`Zeilen: ${(j.rows||[]).length}`);
    }catch(e){
      setStatus("");
      setError("❌ " + e.message);
      renderTable([], include_po);
    }
  }

  $("btnLoad").addEventListener("click", loadReport);
</script>

</body>
</html>
