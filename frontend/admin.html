<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Admin â€“ Zeiterfassung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
    h1,h2 { margin-top:0; }
    .box { background:#fff; padding:20px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    label { display:block; margin-top:10px; font-weight:bold; }
    input,select { width:100%; padding:8px; margin-top:4px; }
    button { margin-top:15px; padding:10px 14px; background:#1565c0; color:white; border:none; border-radius:4px; cursor:pointer; }
    button.danger { background:#c62828; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    th,td { border-bottom:1px solid #ddd; padding:8px; }
    th { background:#eee; }
    tr:hover { background:#f1f1f1; cursor:pointer; }
    pre { background:#eee; padding:10px; border-radius:6px; white-space:pre-wrap; }
    .small { font-size:12px; color:#666; }
    .ok { color: green; font-weight: bold; }
  </style>
</head>
<body>

<h1>Admin â€“ Zeiterfassung</h1>

<!-- ================= STAFFPLAN ================= -->
<div class="box">
  <h2>Staffplan importieren</h2>

  <label>Excel-Datei (Staffplan)</label>
  <input type="file" id="staffplanFile" accept=".xlsx,.xls">

  <button onclick="importStaffplan()">Staffplan importieren</button>
  <button class="danger" onclick="clearStaffplan()">Staffplan lÃ¶schen</button>

  <pre id="staffplanStatus"></pre>
</div>

<!-- ================= EMPLOYEE FORM ================= -->
<div class="box">
  <h2>Mitarbeiter anlegen / Ã¤ndern</h2>

  <label>Mitarbeiter-ID</label>
  <input id="employee_id">

  <label>Name</label>
  <input id="name">

  <label>E-Mail</label>
  <input id="email">

  <label>Sprache</label>
  <select id="language">
    <option value="de">Deutsch</option>
    <option value="en">Englisch</option>
    <option value="sk">Slowakisch</option>
    <option value="hr">Kroatisch</option>
    <option value="ru">Russisch</option>
    <option value="tr">TÃ¼rkisch</option>
  </select>

  <button onclick="saveEmployee()">Speichern</button>

  <pre id="employeeStatus"></pre>
</div>

<!-- ================= EMPLOYEE LIST ================= -->
<div class="box">
  <h2>Alle Mitarbeiter</h2>
  <div class="small">Klick auf einen Mitarbeiter zum Bearbeiten</div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>E-Mail</th>
        <th>Sprache</th>
      </tr>
    </thead>
    <tbody id="employeeTable"></tbody>
  </table>
</div>

<script>
async function importStaffplan() {
  const f = document.getElementById("staffplanFile").files[0];
  if (!f) return alert("Bitte Excel-Datei auswÃ¤hlen");

  const r = new FileReader();
  r.onload = async () => {
    const res = await fetch("/api/import/staffplan", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ fileBase64: r.result.split(",")[1] })
    });
    staffplanStatus.textContent = await res.text();
    await loadEmployees();
  };
  r.readAsDataURL(f);
}

async function clearStaffplan() {
  if (!confirm("Staffplan wirklich lÃ¶schen?")) return;
  const res = await fetch("/api/staffplan/clear", { method: "POST" });
  staffplanStatus.textContent = await res.text();
}

async function loadEmployees() {
  const res = await fetch("/api/employees");
  const data = await res.json();

  const tbody = document.getElementById("employeeTable");
  tbody.innerHTML = "";

  data.forEach(e => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.employee_id}</td>
      <td>${e.name}</td>
      <td>${e.email || ""}</td>
      <td>${e.language || "de"}</td>
    `;
    tr.onclick = () => fillForm(e);
    tbody.appendChild(tr);
  });
}

function fillForm(e) {
  employee_id.value = e.employee_id;
  name.value = e.name;
  email.value = e.email || "";
  language.value = e.language || "de";
}

async function saveEmployee() {
  const payload = {
    employee_id: employee_id.value.trim(),
    name: name.value.trim(),
    email: email.value.trim() || null,
    language: language.value
  };

  if (!payload.employee_id || !payload.name) {
    alert("ID und Name sind Pflicht");
    return;
  }

  const res = await fetch("/api/employees/upsert", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const result = await res.json();
  employeeStatus.innerHTML = `<span class="ok">âœ” Gespeichert</span>\n${JSON.stringify(result, null, 2)}`;

  // ðŸ”§ WICHTIGER FIX
  employee_id.value = "";
  name.value = "";
  email.value = "";
  language.value = "de";

  await loadEmployees();
}

loadEmployees();
</script>

</body>
</html>
