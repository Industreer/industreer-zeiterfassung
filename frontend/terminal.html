<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Zeiterfassung – Terminal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      text-align: center;
      padding: 30px;
    }
    input, select, button {
      font-size: 1.2em;
      padding: 10px;
      margin: 10px 0;
      width: 100%;
      max-width: 300px;
    }
    button {
      cursor: pointer;
    }
    .card {
      background: #222;
      padding: 20px;
      border-radius: 8px;
      display: inline-block;
      width: 100%;
      max-width: 350px;
    }
    .success {
      color: #0f0;
      font-size: 1.3em;
    }
    .error {
      color: #f55;
    }
  </style>
</head>
<body>

<div class="card" id="loginBox">
  <h2>Mitarbeiter Anmeldung</h2>
  <input id="employeeId" placeholder="Mitarbeiter-ID">
  <button onclick="login()">Anmelden</button>
  <div id="loginError" class="error"></div>
</div>

<div class="card" id="projectBox" style="display:none">
  <h2 id="welcome"></h2>
  <select id="projectSelect"></select>
  <button onclick="confirmProject()">Projekt bestätigen</button>
</div>

<div class="card" id="successBox" style="display:none">
  <div class="success" id="successText"></div>
</div>

<script>
let employee = null;

async function login() {
  const id = document.getElementById("employeeId").value.trim();
  if (!id) return;

  const err = document.getElementById("loginError");
  err.innerText = "";

  const res = await fetch(`/api/terminal/login?employee_id=${id}`);
  const data = await res.json();

  if (!res.ok) {
    err.innerText = "Mitarbeiter nicht gefunden";
    return;
  }

  employee = data.employee;
  loadProjects();
}

async function loadProjects() {
  const today = new Date().toISOString().slice(0,10);
  const res = await fetch(
    `/api/allowed-projects?employee_id=${employee.employee_id}&date=${today}`
  );
  const data = await res.json();

  const select = document.getElementById("projectSelect");
  select.innerHTML = "";

  if (data.projects.length === 0) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.text = "Kein Projekt zugewiesen";
    select.appendChild(opt);
  } else {
    for (const p of data.projects) {
      const opt = document.createElement("option");
      opt.value = p.project_id;
      opt.text = `${p.project_id} – ${p.name}`;
      select.appendChild(opt);
    }
  }

  document.getElementById("welcome").innerText =
    `Hallo ${employee.name}`;
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("projectBox").style.display = "block";
}

function confirmProject() {
  const sel = document.getElementById("projectSelect");
  const text = sel.options[sel.selectedIndex].text;

  document.getElementById("projectBox").style.display = "none";
  document.getElementById("successBox").style.display = "block";
  document.getElementById("successText").innerText =
    `${employee.name}\n${text}`;

  setTimeout(resetTerminal, 5000);
}

function resetTerminal() {
  employee = null;
  document.getElementById("employeeId").value = "";
  document.getElementById("successBox").style.display = "none";
  document.getElementById("loginBox").style.display = "block";
}
</script>

</body>
</html>
