<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Zeiterfassung – Terminal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { background:#111; color:#fff; font-family:Arial; text-align:center; padding:22px; }
  .card { background:#222; padding:18px; border-radius:10px; max-width:360px; margin:0 auto 14px; }
  input, select, button { width:100%; padding:12px; margin:8px 0; font-size:1.05em; }
  button { cursor:pointer; }
  .ok { color:#0f0; font-size:1.15em; white-space:pre-line; }
  .err { color:#f66; white-space:pre-line; }
</style>
</head>
<body>

<div class="card" id="loginCard">
  <h2>Mitarbeiter Anmeldung</h2>
  <input id="empId" placeholder="Mitarbeiter-ID">
  <button onclick="login()">Anmelden</button>
  <div class="err" id="loginErr"></div>
</div>

<div class="card" id="projectCard" style="display:none">
  <h2 id="welcome"></h2>
  <select id="projectSelect"></select>
  <input id="manualProject" placeholder="Ausnahme Projekt-ID">
  <button onclick="useManual()">Ausnahme verwenden</button>
  <button onclick="confirmProject()">Weiter</button>
  <div class="err" id="projErr"></div>
</div>

<div class="card" id="actionCard" style="display:none">
  <div class="ok" id="headerText"></div>
<button onclick="sendEvent('clock_in')">Arbeitsbeginn</button>
<button onclick="sendEvent('break_start')">Pause Start</button>
<button onclick="sendEvent('break_end')">Pause Ende</button>
<button onclick="sendEvent('clock_out')">Arbeitsende</button>
  <div class="err" id="eventErr"></div>
</div>

<script>
  let employee = null, projectId = null;

  function todayIso(){ return new Date().toISOString().slice(0,10); }

  // ---------- LOGIN (global für onclick) ----------
  window.login = async function login(){
    const loginErrEl = document.getElementById("loginErr");
    const empEl = document.getElementById("empId");

    loginErrEl.innerText = "";

    const id = (empEl.value || "").trim();
    if(!id){
      loginErrEl.innerText = "Bitte Mitarbeiter-ID oder Namen eingeben";
      return;
    }

    try{
      const r = await fetch(`/api/terminal/login?employee_id=${encodeURIComponent(id)}`);
      const t = await r.text();
      let d; try { d = JSON.parse(t); } catch { d = { ok:false, error:t }; }

      if(!r.ok || d.ok === false){
        loginErrEl.innerText = d.error || "Mitarbeiter nicht gefunden";
        return;
      }

      employee = d.employee;
      await loadProjects();
    }catch(e){
      loginErrEl.innerText = "❌ " + (e.message || String(e));
    }
  };

  // ---------- PROJECTS ----------
  async function loadProjects(){
    const projErrEl = document.getElementById("projErr");
    projErrEl.innerText = "";

    const r = await fetch(`/api/allowed-projects?employee_id=${encodeURIComponent(employee.employee_id)}&date=${todayIso()}`);
    const d = await r.json();

    const projectSelect = document.getElementById("projectSelect");
    projectSelect.innerHTML = "";

    if(d.projects && d.projects.length){
      d.projects.forEach(p=>{
        const o = document.createElement("option");
        o.value = p.project_id;
        o.text = `${p.project_id} – ${p.name}`;
        projectSelect.appendChild(o);
      });
    }else{
      const o = document.createElement("option");
      o.value = "";
      o.text = "Kein Projekt zugewiesen";
      projectSelect.appendChild(o);
    }

    document.getElementById("welcome").innerText = `Hallo ${employee.name}`;
    document.getElementById("loginCard").style.display = "none";
    document.getElementById("projectCard").style.display = "block";
  }

  // ---------- MANUAL PROJECT ----------
  window.useManual = function useManual(){
    const v = (document.getElementById("manualProject").value || "").trim();
    const projErrEl = document.getElementById("projErr");
    projErrEl.innerText = "";

    if(!v){
      projErrEl.innerText = "Projekt-ID fehlt";
      return;
    }
    projectId = v;
    showActions("(Ausnahme)");
  };

  // ---------- CONFIRM PROJECT ----------
  window.confirmProject = function confirmProject(){
    const projErrEl = document.getElementById("projErr");
    projErrEl.innerText = "";

    const v = document.getElementById("projectSelect").value;

    if(!v){
      // staffplan leer oder nichts ausgewählt -> ohne Projekt weiter
      projectId = null;
      showActions("(kein Projekt)");
      return;
    }

    projectId = v;
    showActions("");
  };

  function showActions(extra){
    document.getElementById("projectCard").style.display = "none";
    document.getElementById("actionCard").style.display = "block";
    document.getElementById("headerText").innerText = `${employee.name}\nProjekt: ${projectId || "-"} ${extra}`;
  }

  // ---------- EVENTS ----------
  window.sendEvent = async function sendEvent(type){
    const eventErrEl = document.getElementById("eventErr");
    eventErrEl.innerText = "";

    if(!employee?.employee_id){
      eventErrEl.innerText = "Kein Mitarbeiter";
      return;
    }

    // Mapping zu neuen Endpoints (Variante 2: project_id nur bei clock_in)
    const map = {
      clock_in:    { url: "/api/clock/in",    body: { employee_id: employee.employee_id, project_id: projectId || null } },
      clock_out:   { url: "/api/clock/out",   body: { employee_id: employee.employee_id } },
      break_start: { url: "/api/break/start", body: { employee_id: employee.employee_id } },
      break_end:   { url: "/api/break/end",   body: { employee_id: employee.employee_id } },
    };

    const cfg = map[type];
    if(!cfg){
      eventErrEl.innerText = "Unbekannter Event-Typ";
      return;
    }

    try{
      const r = await fetch(cfg.url, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(cfg.body)
      });
      const t = await r.text();
      let d; try { d = JSON.parse(t); } catch { d = { ok:false, error:t }; }
      if(!r.ok || d.ok === false) throw new Error(d.error || "Zeitbuchung fehlgeschlagen");

      const actionCard = document.getElementById("actionCard");
      actionCard.innerHTML = `<div class="ok">✅ Gespeichert (${type})</div>`;
      setTimeout(()=>location.reload(), 2500);
    }catch(e){
      eventErrEl.innerText = "❌ " + (e.message || String(e));
    }
  };
</script>

</body>
</html>
