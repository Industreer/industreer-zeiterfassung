<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Staffplan – Planung + Abwesenheiten</title>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:1400px}
    h1{margin:0 0 8px}
    .muted{color:#666}
    .ok{color:#0a7b2e}
    .bad{color:#b10000}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .small{font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:10px 12px;font-size:14px}
    input[type="text"]{min-width:220px}
    input[type="date"]{padding:8px 10px}
    button{cursor:pointer}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:14px 0}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid #ddd;background:#fafafa}
    .pill.sick{border-color:#f0b4b4;background:#fff5f5}
    .pill.vac{border-color:#b4d6f0;background:#f5fbff}

    table{border-collapse:collapse;width:100%;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;vertical-align:top}
    th{background:#fafafa;position:sticky;top:0;z-index:1}
    .right{text-align:right}
    .nowrap{white-space:nowrap}
    .w-hrs{min-width:120px}
    .w-actions{min-width:120px}
    .sticky-wrap{max-height:70vh;overflow:auto;border:1px solid #eee;border-radius:12px}

    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
    .modal{background:#fff;border-radius:14px;max-width:780px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,.2);border:1px solid #eee}
    .modal header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #eee}
    .modal header h3{margin:0;font-size:16px}
    .modal main{padding:16px}
    .modal footer{padding:14px 16px;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:10px}
    .btn{border:1px solid #ddd;background:#fff;border-radius:10px}
    .btn.primary{border-color:#111;background:#111;color:#fff}
    .btn.danger{border-color:#b10000;color:#b10000}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .list{margin-top:10px}
    .list .item{border:1px solid #eee;border-radius:12px;padding:12px;margin:10px 0}
    .item .top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
  </style>
</head>

<body>
  <h1>Staffplan – Planung + Abwesenheiten</h1>
  <div class="muted">
    Zeigt geplante Stunden und legt <b>effective_planned_hours</b> automatisch auf 0 bei <b>sick</b>.
    (Zugriff: Admin-Code <span class="mono">2012</span>)
  </div>

  <div class="card">
    <div class="row">
      <label class="muted">Admin-Code:</label>
      <input id="code" type="text" placeholder="2012" style="min-width:120px"/>
      <button id="btnSaveCode" class="btn">Speichern</button>
      <span id="codeOut" class="small muted"></span>
    </div>

    <hr style="border:none;border-top:1px solid #eee;margin:14px 0"/>

    <div class="row">
      <label class="muted">Von:</label>
      <input id="from" type="date"/>
      <label class="muted">Bis:</label>
      <input id="to" type="date"/>

      <button id="btnToday" class="btn">Heute</button>
      <button id="btnThisWeek" class="btn">Diese Woche</button>
      <button id="btnNext7" class="btn">+7 Tage</button>

      <button id="btnLoad" class="btn primary">Laden</button>
      <span id="statusTop" class="muted small"></span>
    </div>

    <div class="row" style="margin-top:10px">
      <label class="muted">Suche:</label>
      <input id="q" type="text" placeholder="Name / ID / Projekt / PO ..."/>
      <label class="muted">Filter:</label>
      <select id="absenceFilter">
        <option value="all">Alle</option>
        <option value="sick">Nur sick</option>
        <option value="vacation">Nur vacation</option>
        <option value="none">Nur ohne Abwesenheit</option>
      </select>
      <label class="muted">Sort:</label>
      <select id="sort">
        <option value="date_name">Datum → Name</option>
        <option value="name_date">Name → Datum</option>
      </select>
    </div>
  </div>

  <div class="card">
    <div class="muted small">
      Tipp: <b>planned_hours</b> ändern → Feld verlassen (blur) speichert automatisch.
      „Abwesenheiten“ öffnet den Editor pro Mitarbeiter.
    </div>

    <div class="sticky-wrap" style="margin-top:10px">
      <table>
        <thead>
          <tr>
            <th class="nowrap">Datum</th>
            <th>ID</th>
            <th>Name</th>
            <th>Customer PO</th>
            <th>Internal PO</th>
            <th>Projekt</th>
            <th class="right w-hrs">planned_hours</th>
            <th class="right w-hrs">effective</th>
            <th>Abwesenheit</th>
            <th class="w-actions">Aktionen</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div id="statusBottom" class="muted small" style="margin-top:10px"></div>
  </div>

  <!-- Absences Modal -->
  <div id="absBackdrop" class="backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <h3 id="absTitle">Abwesenheiten</h3>
        <button id="btnAbsCloseX" class="btn">✕</button>
      </header>
      <main>
        <div class="grid">
          <div>
            <div class="muted small" style="margin-bottom:6px">Typ</div>
            <select id="absType" style="width:100%">
              <option value="sick">sick (Krank)</option>
              <option value="vacation">vacation (Urlaub)</option>
            </select>
          </div>
          <div>
            <div class="muted small" style="margin-bottom:6px">Notiz</div>
            <input id="absNote" type="text" placeholder="z.B. AU, Urlaub, ..." style="width:100%"/>
          </div>
          <div>
            <div class="muted small" style="margin-bottom:6px">Von</div>
            <input id="absFrom" type="date" style="width:100%"/>
          </div>
          <div>
            <div class="muted small" style="margin-bottom:6px">Bis</div>
            <input id="absTo" type="date" style="width:100%"/>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="btnAbsCreate" class="btn primary">Speichern</button>
          <button id="btnAbsRefresh" class="btn">Neu laden</button>
          <span id="absOut" class="small muted"></span>
        </div>

        <div class="list">
          <div class="muted small" style="margin-top:14px">Aktive Abwesenheiten</div>
          <div id="absList"></div>
        </div>
      </main>
      <footer>
        <button id="btnAbsClose" class="btn">Schließen</button>
      </footer>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  // ---------- Dates (Berlin) ----------
  function todayIsoBerlin(){
    const fmt = new Intl.DateTimeFormat("en-CA", {
      timeZone: "Europe/Berlin",
      year: "numeric", month:"2-digit", day:"2-digit"
    });
    return fmt.format(new Date()); // YYYY-MM-DD
  }
  function addDays(iso, days){
    const d = new Date(iso + "T00:00:00.000Z");
    d.setUTCDate(d.getUTCDate() + days);
    return d.toISOString().slice(0,10);
  }
  function weekRangeBerlin(iso){
    // iso -> compute Monday..Sunday in UTC based on date value
    const d = new Date(iso + "T00:00:00.000Z");
    const day = (d.getUTCDay() + 6) % 7; // Mon=0 ... Sun=6
    const mon = new Date(d);
    mon.setUTCDate(d.getUTCDate() - day);
    const sun = new Date(mon);
    sun.setUTCDate(mon.getUTCDate() + 6);
    return [mon.toISOString().slice(0,10), sun.toISOString().slice(0,10)];
  }

  // ---------- Escape ----------
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ---------- Admin Code handling ----------
  function getAdminCode(){
    return (sessionStorage.getItem("admin_code") || $("code")?.value || "").trim();
  }
  function setAdminCode(v){
    sessionStorage.setItem("admin_code", String(v||"").trim());
  }

  // ---------- API ----------
  async function api(url, options){
    const code = getAdminCode();
    const headers = options?.headers ? {...options.headers} : {};
    // JSON only by default
    if (!headers["Content-Type"] && !(options?.body instanceof FormData)) {
      headers["Content-Type"] = "application/json";
    }
    if (code) headers["x-admin-code"] = code;

    const r = await fetch(url, { ...options, headers });
    const t = await r.text();
    let j;
    try { j = JSON.parse(t); } catch { j = { ok:false, raw:t }; }

    if(!r.ok || j.ok === false) {
      const msg = j.error || j.message || t || ("HTTP " + r.status);
      throw new Error(msg);
    }
    return j;
  }

  // ---------- State ----------
  let allRows = [];
  let absEmployeeId = null;
  let absEmployeeName = null;

  // ---------- Render ----------
  function normalizeStr(s){ return String(s||"").trim().toLowerCase(); }

  function renderRows(rows){
    const q = normalizeStr($("q")?.value);
    const aFilter = $("absenceFilter")?.value || "all";
    const sort = $("sort")?.value || "date_name";

    let out = (rows || []).slice();

    if(q){
      out = out.filter(r => {
        const blob = [
          r.employee_id, r.employee_name, r.customer_po, r.internal_po, r.project_short, r.customer, r.requester_name
        ].map(x=>String(x||"")).join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    if(aFilter === "sick") out = out.filter(r => r.absence_type === "sick");
    if(aFilter === "vacation") out = out.filter(r => r.absence_type === "vacation");
    if(aFilter === "none") out = out.filter(r => !r.absence_type);

    out.sort((a,b)=>{
      const da = String(a.work_date||"");
      const db = String(b.work_date||"");
      const na = String(a.employee_name||"");
      const nb = String(b.employee_name||"");
      if(sort === "name_date"){
        if(na !== nb) return na.localeCompare(nb);
        return da.localeCompare(db);
      }
      // date_name
      if(da !== db) return da.localeCompare(db);
      return na.localeCompare(nb);
    });

    const tb = $("tbody");
    if(!tb) return;

    tb.innerHTML = out.map(r => {
      const isoDate = String(r.work_date||"").slice(0,10);
      const absence = r.absence_type;
      const pill = absence
        ? `<span class="pill ${absence==='sick'?'sick':'vac'}">${absence}</span>`
        : `<span class="muted small">—</span>`;

      const key = {
        employee_id: r.employee_id,
        work_date: isoDate,
        customer_po: r.customer_po ?? null,
        internal_po: r.internal_po ?? null,
        project_short: r.project_short ?? null
      };

      const planned = (r.planned_hours ?? "");
      const effective = (r.effective_planned_hours ?? "");

      return `
        <tr>
          <td class="nowrap">${esc(isoDate)}</td>
          <td class="mono">${esc(r.employee_id)}</td>
          <td>${esc(r.employee_name)}</td>
          <td>${esc(r.customer_po)}</td>
          <td>${esc(r.internal_po)}</td>
          <td>${esc(r.project_short)}</td>
          <td class="right">
            <input
              class="w-hrs"
              style="text-align:right"
              type="number" step="0.25" min="0"
              data-action="edit-planned"
              data-key='${esc(JSON.stringify(key))}'
              value="${esc(planned)}"
              placeholder="—"
            />
          </td>
          <td class="right mono">${esc(effective)}</td>
          <td>${pill}</td>
          <td>
            <button
              class="btn"
              data-action="absences"
              data-employee-id="${esc(r.employee_id)}"
              data-employee-name="${esc(r.employee_name)}"
            >Abwesenheiten</button>
          </td>
        </tr>
      `;
    }).join("");

    const txt = `Zeilen: ${out.length} (gesamt geladen: ${(rows||[]).length})`;
    if($("statusTop")) $("statusTop").textContent = txt;
    if($("statusBottom")) $("statusBottom").textContent = txt;
  }

  // ---------- Load staffplan overlay ----------
  async function loadStaffplan(){
    const st = $("statusTop");
    if(st){ st.className = "muted small"; st.textContent = "Lade…"; }

    const from = $("from")?.value || "";
    const to = $("to")?.value || "";

    if(!/^\d{4}-\d{2}-\d{2}$/.test(from)) throw new Error("Bitte gültiges 'Von' Datum setzen.");
    if(!/^\d{4}-\d{2}-\d{2}$/.test(to)) throw new Error("Bitte gültiges 'Bis' Datum setzen.");
    if(to < from) throw new Error("'Bis' darf nicht vor 'Von' liegen.");

    const j = await api(`/api/admin/staffplan/with-absences?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);
    allRows = j.rows || [];
    renderRows(allRows);
  }

  // ---------- planned_hours update ----------
  async function savePlannedHours(inputEl){
    const rawKey = inputEl?.dataset?.key;
    if(!rawKey) return;

    let key;
    try { key = JSON.parse(rawKey); } catch { return; }

    const v = String(inputEl.value ?? "").trim();
    let planned_hours = null;
    if(v !== ""){
      const n = Number(v);
      if(!isFinite(n) || n < 0){
        inputEl.style.outline = "2px solid #b10000";
        setTimeout(()=> inputEl.style.outline = "", 1200);
        alert("❌ planned_hours ungültig");
        return;
      }
      planned_hours = n;
    }

    const prev = inputEl.style.outline;
    inputEl.disabled = true;
    try{
      await api("/api/admin/staffplan/planned-hours", {
        method: "PATCH",
        body: JSON.stringify({ ...key, planned_hours })
      });
      inputEl.style.outline = "2px solid #0a7b2e";
      setTimeout(()=> inputEl.style.outline = prev, 700);

      // reload to recompute effective_planned_hours
      await loadStaffplan();
    }catch(e){
      inputEl.style.outline = "2px solid #b10000";
      setTimeout(()=> inputEl.style.outline = prev, 1200);
      alert("❌ Konnte nicht speichern: " + e.message);
    }finally{
      inputEl.disabled = false;
    }
  }

  // ---------- Absences modal ----------
  function setAbsOutput(msg, ok){
    const out = $("absOut");
    if(!out) return;
    if(ok === true){ out.className = "small ok"; }
    else if(ok === false){ out.className = "small bad"; }
    else { out.className = "small muted"; }
    out.textContent = msg || "";
  }

  function openAbsences(employee_id, employee_name){
    absEmployeeId = employee_id;
    absEmployeeName = employee_name;

    $("absTitle").innerHTML = `Abwesenheiten – <b>${esc(employee_name)}</b> <span class="mono">${esc(employee_id)}</span>`;
    const t = todayIsoBerlin();
    if($("absFrom")) $("absFrom").value = t;
    if($("absTo")) $("absTo").value = t;
    if($("absNote")) $("absNote").value = "";
    if($("absType")) $("absType").value = "sick";

    $("absBackdrop").style.display = "flex";
    refreshAbsences().catch(e=> setAbsOutput("❌ " + e.message, false));
  }

  function closeAbsences(){
    $("absBackdrop").style.display = "none";
    absEmployeeId = null;
    absEmployeeName = null;
    setAbsOutput("", null);
    if($("absList")) $("absList").innerHTML = "";
  }

  function renderAbsList(rows){
    const wrap = $("absList");
    if(!wrap) return;

    if(!rows.length){
      wrap.innerHTML = `<div class="muted small" style="margin-top:8px">Keine aktiven Abwesenheiten.</div>`;
      return;
    }

    wrap.innerHTML = rows.map(r=>{
      const from = String(r.date_from||"").slice(0,10);
      const to = String(r.date_to||"").slice(0,10);
      const pill = r.type === "sick"
        ? `<span class="pill sick">sick</span>`
        : `<span class="pill vac">vacation</span>`;

      return `
        <div class="item">
          <div class="top">
            <div>
              ${pill}
              <div class="mono small" style="margin-top:6px">${esc(from)} → ${esc(to)}</div>
              <div class="muted small" style="margin-top:4px">${esc(r.note || "")}</div>
            </div>
            <div class="row" style="justify-content:flex-end">
              <button class="btn" data-action="abs-cancel" data-id="${esc(r.id)}">Cancel</button>
              <button class="btn danger" data-action="abs-del" data-id="${esc(r.id)}">Delete</button>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  async function refreshAbsences(){
    if(!absEmployeeId) return;
    setAbsOutput("Lade…", null);
    const j = await api(`/api/admin/absences?employee_id=${encodeURIComponent(absEmployeeId)}&status=active`);
    renderAbsList(j.rows || []);
    setAbsOutput("", null);
  }

  async function createAbsence(){
    if(!absEmployeeId) return;
    const type = $("absType")?.value || "sick";
    const date_from = $("absFrom")?.value || "";
    const date_to = $("absTo")?.value || "";
    const note = ($("absNote")?.value || "").trim();

    if(!/^\d{4}-\d{2}-\d{2}$/.test(date_from) || !/^\d{4}-\d{2}-\d{2}$/.test(date_to)){
      setAbsOutput("Bitte von/bis korrekt setzen.", false);
      return;
    }
    if(date_to < date_from){
      setAbsOutput("'Bis' darf nicht vor 'Von' liegen.", false);
      return;
    }

    setAbsOutput("Speichern…", null);
    await api("/api/admin/absences", {
      method: "POST",
      body: JSON.stringify({ employee_id: absEmployeeId, type, date_from, date_to, note })
    });

    setAbsOutput("✅ Gespeichert", true);
    await refreshAbsences();
    await loadStaffplan(); // overlay neu
  }

  async function cancelAbsence(id){
    setAbsOutput("Cancel…", null);
    await api(`/api/admin/absences/${encodeURIComponent(id)}`, {
      method: "PATCH",
      body: JSON.stringify({ status: "cancelled" })
    });
    await refreshAbsences();
    await loadStaffplan();
    setAbsOutput("✅ Gecancelt", true);
  }

  async function deleteAbsence(id){
    if(!confirm("Wirklich löschen?")) return;
    setAbsOutput("Löschen…", null);
    await api(`/api/admin/absences/${encodeURIComponent(id)}`, { method: "DELETE" });
    await refreshAbsences();
    await loadStaffplan();
    setAbsOutput("✅ Gelöscht", true);
  }

  // ---------- Events ----------
  $("btnSaveCode")?.addEventListener("click", ()=>{
    const v = ($("code")?.value || "").trim();
    setAdminCode(v);
    const out = $("codeOut");
    if(out){
      out.className = v ? "small ok" : "small bad";
      out.textContent = v ? "✅ gespeichert (session)" : "❌ leer";
    }
  });

  $("btnToday")?.addEventListener("click", ()=>{
    const t = todayIsoBerlin();
    $("from").value = t; $("to").value = t;
  });
  $("btnThisWeek")?.addEventListener("click", ()=>{
    const [a,b] = weekRangeBerlin(todayIsoBerlin());
    $("from").value = a; $("to").value = b;
  });
  $("btnNext7")?.addEventListener("click", ()=>{
    const a = todayIsoBerlin();
    $("from").value = a;
    $("to").value = addDays(a, 7);
  });

  $("btnLoad")?.addEventListener("click", ()=>{
    loadStaffplan().catch(e=>{
      if($("statusTop")){
        $("statusTop").className = "bad small";
        $("statusTop").textContent = "❌ " + e.message;
      }
    });
  });

  $("q")?.addEventListener("input", ()=> renderRows(allRows));
  $("absenceFilter")?.addEventListener("change", ()=> renderRows(allRows));
  $("sort")?.addEventListener("change", ()=> renderRows(allRows));

  document.addEventListener("blur", (e)=>{
    const el = e.target;
    if(!el) return;
    if(el.matches("input[data-action='edit-planned'][data-key]")){
      savePlannedHours(el);
    }
  }, true);

  document.addEventListener("click", (e)=>{
    const el = e.target;
    if(!el) return;

    if(el.matches("button[data-action='absences'][data-employee-id]")){
      openAbsences(el.dataset.employeeId, el.dataset.employeeName || el.dataset.employeeId);
      return;
    }
    if(el.matches("button[data-action='abs-cancel'][data-id]")){
      cancelAbsence(el.dataset.id).catch(err=> setAbsOutput("❌ " + err.message, false));
      return;
    }
    if(el.matches("button[data-action='abs-del'][data-id]")){
      deleteAbsence(el.dataset.id).catch(err=> setAbsOutput("❌ " + err.message, false));
      return;
    }
  });

  $("btnAbsClose")?.addEventListener("click", closeAbsences);
  $("btnAbsCloseX")?.addEventListener("click", closeAbsences);
  $("btnAbsRefresh")?.addEventListener("click", ()=> refreshAbsences().catch(e=>setAbsOutput("❌ "+e.message,false)));
  $("btnAbsCreate")?.addEventListener("click", ()=> createAbsence().catch(e=>setAbsOutput("❌ "+e.message,false)));

  // click outside modal closes
  $("absBackdrop")?.addEventListener("click", (e)=>{
    if(e.target === $("absBackdrop")) closeAbsences();
  });

  // ---------- Init ----------
  (function init(){
    // load code from session
    const saved = sessionStorage.getItem("admin_code") || "";
    if($("code")) $("code").value = saved;

    // default date range: today
    const t = todayIsoBerlin();
    $("from").value = t;
    $("to").value = t;

    // optional initial load
    // loadStaffplan().catch(()=>{});
  })();
</script>

</body>
</html>
